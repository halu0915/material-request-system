# 郵件發送問題排查指南

## 🔍 常見問題和解決方案

### 1. 錯誤訊息：「郵件服務未配置」

**原因：** 缺少必要的環境變數

**解決方案：**
在 Render Dashboard 中設定以下環境變數：

```env
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
SMTP_FROM=noreply@your-domain.com  # 可選
```

### 2. 錯誤訊息：「SMTP 連線失敗」

**可能原因：**
- SMTP 伺服器地址錯誤
- 端口號錯誤
- 網路連線問題
- 防火牆阻擋

**解決方案：**
1. 確認 SMTP_HOST 和 SMTP_PORT 正確
2. Gmail 使用：
   - SMTP_HOST: `smtp.gmail.com`
   - SMTP_PORT: `587` (TLS) 或 `465` (SSL)
3. 檢查 Render 的網路設定

### 3. 錯誤訊息：「認證失敗」或「Invalid login」

**可能原因：**
- SMTP_USER 或 SMTP_PASS 錯誤
- Gmail 需要使用「應用程式密碼」而非一般密碼
- 帳號未啟用「允許安全性較低的應用程式」

**解決方案：**

#### Gmail 設定步驟：
1. 啟用兩步驟驗證
2. 產生應用程式密碼：
   - 前往 Google 帳戶設定
   - 安全性 → 兩步驟驗證 → 應用程式密碼
   - 選擇「郵件」和「其他（自訂名稱）」
   - 複製產生的 16 位密碼
3. 使用應用程式密碼作為 SMTP_PASS

### 4. 錯誤訊息：「發送郵件失敗：未知錯誤」

**排查步驟：**

1. **檢查 Render 日誌**
   - 前往 Render Dashboard → Logs
   - 查看詳細錯誤訊息

2. **檢查環境變數**
   ```bash
   # 確認以下變數都已設定
   SMTP_HOST
   SMTP_PORT
   SMTP_USER
   SMTP_PASS
   ```

3. **測試 SMTP 連線**
   - 系統會自動驗證 SMTP 連線
   - 如果驗證失敗，會顯示詳細錯誤訊息

### 5. 郵件發送成功但收不到

**可能原因：**
- 郵件被歸類為垃圾郵件
- 收件人地址錯誤
- 郵件伺服器延遲

**解決方案：**
1. 檢查垃圾郵件資料夾
2. 確認收件人地址正確
3. 檢查 PURCHASE_EMAIL_RECIPIENTS 設定
4. 等待幾分鐘後再檢查

## 📋 環境變數檢查清單

### 必要變數：
- [ ] `SMTP_HOST` - SMTP 伺服器地址
- [ ] `SMTP_PORT` - SMTP 端口（通常 587 或 465）
- [ ] `SMTP_USER` - SMTP 使用者名稱（通常是郵件地址）
- [ ] `SMTP_PASS` - SMTP 密碼（Gmail 需使用應用程式密碼）

### 可選變數：
- [ ] `SMTP_FROM` - 發送者地址（預設使用 SMTP_USER）
- [ ] `PURCHASE_EMAIL_RECIPIENTS` - 採購郵件收件人（多個用逗號分隔）

## 🔧 Gmail SMTP 設定範例

```env
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=xxxx xxxx xxxx xxxx  # 16位應用程式密碼
SMTP_FROM=your-email@gmail.com
PURCHASE_EMAIL_RECIPIENTS=procurement@example.com,manager@example.com
```

## 🔧 其他郵件服務商設定

### Outlook/Hotmail
```env
SMTP_HOST=smtp-mail.outlook.com
SMTP_PORT=587
```

### Yahoo Mail
```env
SMTP_HOST=smtp.mail.yahoo.com
SMTP_PORT=587
```

### 公司郵件伺服器
```env
SMTP_HOST=mail.your-company.com
SMTP_PORT=587  # 或 25, 465
SMTP_USER=system@your-company.com
SMTP_PASS=your-password
```

## 📝 測試郵件發送

1. **建立叫料單**
   - 系統會自動發送郵件

2. **手動發送郵件**
   - 點擊「📧 發送郵件」按鈕
   - 查看是否顯示成功訊息

3. **檢查日誌**
   - Render Dashboard → Logs
   - 查看「郵件發送成功」或錯誤訊息

## 🆘 仍無法解決？

如果以上方法都無法解決問題，請提供以下資訊：

1. **錯誤訊息**（從 Render 日誌複製）
2. **環境變數設定**（隱藏敏感資訊）
3. **使用的郵件服務商**（Gmail、Outlook 等）
4. **是否已設定應用程式密碼**（Gmail）

## 📚 相關文件

- `SMTP設定說明.md` - SMTP 詳細設定指南
- `雲端上傳與郵件設定指南.md` - 完整設定流程
- `郵件自動發送說明.md` - 郵件發送時機說明

