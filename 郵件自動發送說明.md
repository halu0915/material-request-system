# 郵件自動發送說明

## 📧 自動發送郵件的時機

### ✅ 唯一觸發時機：建立叫料單時

系統會在**建立新叫料單時**自動發送郵件。

## 🔄 完整流程

當用戶建立叫料單時，系統會自動執行以下步驟：

1. **建立叫料單**
   - 用戶填寫叫料單資訊（工區、施工類別、材料項目等）
   - 系統生成叫料單號（格式：W00111292025）

2. **生成 Excel 檔案**
   - 自動生成格式化的 Excel 檔案
   - 包含公司抬頭、統編、材料明細、月統計等

3. **上傳到 Google Drive**（如果已配置）
   - 自動上傳 Excel 檔案到 Google Drive
   - 儲存檔案 URL 到資料庫

4. **自動發送郵件**（如果已配置）
   - 自動發送郵件給設定的收件人
   - 郵件包含叫料單詳細資訊和 Excel 附件

5. **發送 LINE 通知**（如果已配置）
   - 自動發送 LINE 通知給使用者

## 📋 郵件發送條件

### 必要條件

1. **SMTP 設定已配置**
   ```env
   SMTP_HOST=smtp.gmail.com
   SMTP_PORT=587
   SMTP_USER=your-email@gmail.com
   SMTP_PASS=your-app-password
   ```

2. **有收件人**
   - 如果設定了 `PURCHASE_EMAIL_RECIPIENTS`，發送給所有指定的收件人
   - 如果未設定，發送給建立叫料單的使用者

### 發送條件檢查

系統會檢查以下條件：

```javascript
// 1. 檢查 SMTP 是否已配置
if (!process.env.SMTP_HOST || !process.env.SMTP_USER) {
  console.warn('郵件服務未配置');
  return; // 跳過發送，不報錯
}

// 2. 檢查是否有收件人
if (recipients.length > 0) {
  // 發送郵件
} else {
  console.warn('未設定郵件收件人，跳過郵件發送');
}
```

## ⚠️ 不會發送郵件的情況

以下情況**不會**自動發送郵件：

1. ❌ **SMTP 未配置**
   - 如果 `SMTP_HOST` 或 `SMTP_USER` 未設定
   - 系統會跳過發送，但不會報錯

2. ❌ **沒有收件人**
   - 如果未設定 `PURCHASE_EMAIL_RECIPIENTS` 且建立者沒有郵件地址
   - 系統會跳過發送

3. ❌ **其他操作**
   - 更新叫料單時：**不會**發送郵件
   - 刪除叫料單時：**不會**發送郵件
   - 下載 Excel 時：**不會**發送郵件
   - 查看叫料單時：**不會**發送郵件
   - 建立物料時：**不會**發送郵件

## 📧 郵件內容

### 主旨格式
```
材料申購 - 物料名稱1、物料名稱2...
```

例如：
- `材料申購 - 水泥、鋼筋`
- `材料申購 - 砂石、模板`

### 郵件內容
```
感謝您的收信，以下是採購清單，如有疑問，請儘速與我聯繫。

叫料單資訊：
- 叫料單號：W00111292025
- 建立日期：2025/11/29 12:00:00
- 工區：A區
- 施工類別：基礎工程

採購清單：
[完整的材料明細表格]

附件：Excel 檔案
```

## 🔍 如何確認郵件是否發送

### 方法 1：檢查 Render 日誌

在 Render Dashboard 中查看日誌，應該會看到：
```
郵件發送成功: procurement@example.com
```

或

```
郵件服務未配置
```

### 方法 2：檢查資料庫

查詢 `material_requests` 表，檢查 `email_sent` 欄位：
```sql
SELECT request_number, email_sent FROM material_requests;
```

如果 `email_sent = true`，表示郵件已發送。

### 方法 3：檢查收件箱

檢查設定的收件人郵件信箱（包括垃圾郵件資料夾）。

## 💡 設定範例

### 完整環境變數設定

```env
# SMTP 設定（必要）
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
SMTP_FROM=noreply@your-domain.com

# 採購郵件收件人（可選，多個用逗號分隔）
PURCHASE_EMAIL_RECIPIENTS=procurement@example.com,manager@example.com,buyer@example.com
```

### 發送邏輯

1. **如果設定了 `PURCHASE_EMAIL_RECIPIENTS`**
   - 發送給所有指定的收件人
   - 例如：`procurement@example.com,manager@example.com`
   - 會發送 2 封郵件

2. **如果未設定 `PURCHASE_EMAIL_RECIPIENTS`**
   - 發送給建立叫料單的使用者
   - 使用使用者的註冊郵件地址

## 📝 總結

**自動發送郵件的唯一時機：**
- ✅ 建立新叫料單時

**不會發送郵件的情況：**
- ❌ SMTP 未配置
- ❌ 沒有收件人
- ❌ 更新、刪除、查看叫料單時
- ❌ 其他任何操作時

**郵件內容：**
- 主旨：材料申購 - 物料名稱
- 內容：感謝訊息 + 採購清單
- 附件：Excel 檔案

