<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>å«æ–™ç³»çµ± - ä¸»é </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Noto Sans JP', sans-serif;
            background: #fafafa;
            min-height: 100vh;
            color: #2c3e50;
        }
        .header {
            background: linear-gradient(135deg, #347773 0%, #2d6561 100%);
            color: #ffffff;
            padding: 24px 20px;
            box-shadow: 0 4px 12px rgba(52, 119, 115, 0.25);
            border-bottom: 2px solid rgba(52, 119, 115, 0.3);
            position: relative;
            z-index: 100;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            font-size: 1.5rem;
            cursor: pointer;
            font-weight: 700;
            color: #ffffff;
            letter-spacing: -0.02em;
            transition: all 0.3s ease;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .header h1:hover {
            color: #e8f5f4;
            transform: translateY(-1px);
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            color: #ffffff;
            font-size: 0.9375rem;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 16px;
            border-radius: 20px;
            -webkit-backdrop-filter: blur(5px);
                backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }
        .welcome-card {
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 30px;
        }
        .welcome-card h2 {
            color: #111827;
            margin-bottom: 10px;
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1.2;
        }
        .welcome-card p {
            color: #6b7280;
            font-size: 1.125rem;
        }
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .feature-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s;
            cursor: pointer;
        }
        .feature-card:hover {
            transform: translateY(-5px);
        }
        .feature-icon {
            font-size: 3.5rem;
            margin-bottom: 15px;
        }
        .feature-card h3 {
            color: #111827;
            margin-bottom: 10px;
            font-size: 1.375rem;
            font-weight: 700;
        }
        .feature-card p {
            color: #6b7280;
            font-size: 0.9375rem;
        }
        .section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 30px;
        }
        .section-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
            flex-wrap: wrap;
            gap: 10px;
            position: relative;
        }
        .section-header h2 {
            color: #111827;
            font-size: 1.875rem;
            font-weight: 700;
            line-height: 1.3;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-direction: row;
            justify-content: center;
            position: relative;
            width: 100%;
        }
        .section-header h2 span {
            flex: 1;
            text-align: center;
            font-size: 1.875rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            pointer-events: none;
        }
        .back-btn {
            background: linear-gradient(135deg, #347773 0%, #2d6561 100%);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.65rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 2px;
            min-height: 24px;
            min-width: 28px;
            flex-shrink: 0;
            transition: all 0.2s;
            box-shadow: 0 1px 4px rgba(52, 119, 115, 0.2);
            font-weight: 600;
            position: absolute;
            left: 0;
            z-index: 100;
            pointer-events: auto;
        }
        .back-btn:hover {
            background: linear-gradient(135deg, #2d6561 0%, #25605c 100%);
            box-shadow: 0 2px 6px rgba(52, 119, 115, 0.3);
        }
        .back-btn:active {
            transform: scale(0.95);
            box-shadow: 0 1px 3px rgba(52, 119, 115, 0.25);
        }
        .btn-primary {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-primary:hover {
            background: #5568d3;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .btn-small {
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }
        tr:hover {
            background: #f8f9fa;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        .form-group textarea {
            min-height: 100px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 700px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        .modal-header h3 {
            color: #333;
        }
        .close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #667eea;
            font-size: 1rem;
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            font-size: 0.95rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 20px 0;
        }
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .stat-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 16px;
            padding: 28px 24px;
            text-align: center;
            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 100%);
            pointer-events: none;
        }
        .stat-card:nth-child(1) {
            background: linear-gradient(135deg, #56ccf2 0%, #2f80ed 100%);
            box-shadow: 0 8px 24px rgba(47, 128, 237, 0.25);
        }
        .stat-card:nth-child(2) {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            box-shadow: 0 8px 24px rgba(79, 172, 254, 0.25);
        }
        .stat-card:nth-child(3) {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            box-shadow: 0 8px 24px rgba(9, 132, 227, 0.25);
        }
        .stat-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 12px 32px rgba(79, 172, 254, 0.35);
        }
        .stat-card:nth-child(1):hover {
            box-shadow: 0 12px 32px rgba(47, 128, 237, 0.35);
        }
        .stat-card:nth-child(2):hover {
            box-shadow: 0 12px 32px rgba(79, 172, 254, 0.35);
        }
        .stat-card:nth-child(3):hover {
            box-shadow: 0 12px 32px rgba(9, 132, 227, 0.35);
        }
        .stat-card h3 {
            color: rgba(255, 255, 255, 0.98);
            font-size: 0.875rem;
            font-weight: 600;
            margin: 0 0 16px 0;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            position: relative;
            z-index: 1;
            opacity: 0.95;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.4;
        }
        .stat-number {
            color: white;
            font-size: 2.75rem;
            font-weight: 800;
            margin: 0;
            line-height: 1.1;
            text-shadow: 0 3px 12px rgba(0, 0, 0, 0.3), 0 1px 3px rgba(0, 0, 0, 0.2);
            letter-spacing: -1px;
            position: relative;
            z-index: 1;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            display: block;
            word-break: break-word;
        }
        .request-item {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #ffffff 100%);
            border-radius: 12px;
            border: 1px solid #e1e8ed;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .request-item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 12px;
            align-items: start;
        }
        .request-item-row-full {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }
        .request-item-row-2col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .image-upload-area {
            position: relative;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f8fafc;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .image-upload-area:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        .image-upload-area input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }
        .image-preview {
            margin-top: 10px;
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .image-preview-container {
            position: relative;
            display: inline-block;
        }
        .remove-image-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .link-input-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .link-input-group input {
            flex: 1;
        }
        .link-icon {
            color: #667eea;
            font-size: 18px;
        }
        /* Mobile Card Layout for Tables */
        .mobile-card {
            display: none !important;
        }
        /* Desktop: show table */
        table {
            display: table !important;
        }
        /* Ensure tables are visible on desktop by default */
        .section table,
        .modal table,
        #materials-content > table,
        #requests-content > table,
        #category-list-content > table,
        #address-list-content > table {
            display: table !important;
        }
        .mobile-card-item {
            background: white;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .mobile-card-item-header {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }
        .mobile-card-item-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 8px 0;
            border-bottom: 1px solid #f8f9fa;
        }
        .mobile-card-item-row:last-child {
            border-bottom: none;
        }
        .mobile-card-item-label {
            font-weight: 600;
            color: #666;
            min-width: 80px;
            flex-shrink: 0;
        }
        .mobile-card-item-value {
            color: #333;
            text-align: right;
            flex: 1;
            word-break: break-word;
        }
        .mobile-card-item-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #f0f0f0;
        }
        .mobile-card-item-actions button {
            width: 100%;
        }
        
        /* Bottom Navigation Bar for Mobile */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 999;
            padding: 8px 0 calc(8px + env(safe-area-inset-bottom));
            display: none; /* Hidden by default on desktop */
            justify-content: space-around;
            align-items: center;
        }
        .bottom-nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 4px;
            text-decoration: none;
            color: #6b7280;
            font-size: 0.75rem;
            transition: all 0.2s;
            min-height: 56px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        .bottom-nav-item:active {
            transform: scale(0.95);
        }
        .bottom-nav-item.active {
            color: #667eea;
        }
        .bottom-nav-item.active .bottom-nav-item-icon {
            transform: scale(1.1);
        }
        .bottom-nav-item-icon {
            font-size: 1.5rem;
            margin-bottom: 4px;
            transition: transform 0.2s;
        }
        .bottom-nav-item-text {
            font-weight: 500;
            font-size: 0.6875rem;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            /* Show bottom navigation on mobile */
            .bottom-nav {
                display: flex !important;
                visibility: visible !important;
                opacity: 1 !important;
            }
            
            /* Safe area support for notched devices */
            body {
                padding-bottom: 70px !important;
            }
            
            /* Header improvements */
            .header {
                padding: 16px 20px;
                position: relative;
                z-index: 100;
                background: linear-gradient(135deg, #347773 0%, #2d6561 100%);
                -webkit-backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
                box-shadow: 0 4px 12px rgba(52, 119, 115, 0.25);
                border-bottom: 2px solid rgba(52, 119, 115, 0.3);
            }
            .header-content {
                flex-direction: row;
                gap: 12px;
                align-items: center;
            }
            .header h1 {
                font-size: 1.25rem;
                flex: 1;
                font-weight: 700;
                color: #ffffff;
                letter-spacing: -0.01em;
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            }
            .user-info {
                gap: 8px;
                font-size: 0.875rem;
                color: #ffffff;
                font-weight: 600;
                background: rgba(255, 255, 255, 0.15);
                padding: 6px 12px;
                border-radius: 16px;
                -webkit-backdrop-filter: blur(5px);
                backdrop-filter: blur(5px);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }
            .user-info button {
                padding: 8px 12px;
                font-size: 0.875rem;
            }
            
            /* Container and spacing */
            .container {
                margin: 16px auto;
                padding: 0 16px;
                padding-bottom: 80px; /* Space for bottom nav */
            }
            
            /* Welcome card */
            .welcome-card {
                padding: 24px 20px;
                border-radius: 16px;
                margin-bottom: 20px;
            }
            .welcome-card h2 {
                font-size: 1.5rem;
                margin-bottom: 8px;
            }
            .welcome-card p {
                font-size: 1rem;
            }
            
            /* Features grid */
            .features {
                grid-template-columns: 1fr;
                gap: 12px;
                margin-top: 20px;
            }
            .feature-card {
                padding: 28px 24px;
                border-radius: 16px;
                min-height: 140px;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }
            .feature-icon {
                font-size: 3rem;
                margin-bottom: 16px;
            }
            .feature-card h3 {
                font-size: 1.375rem;
                font-weight: 700;
                margin-bottom: 10px;
                color: #111827;
            }
            .feature-card p {
                font-size: 1rem;
                color: #6b7280;
            }
            
            /* Section improvements */
            .section {
                padding: 24px 20px;
                margin-top: 16px;
                border-radius: 16px;
            }
            .section-header {
                flex-direction: row;
                align-items: center;
                justify-content: center;
                gap: 12px;
                margin-bottom: 24px;
                padding-bottom: 20px;
                position: relative;
            }
            .section-header h2 {
                font-size: 1.875rem;
                font-weight: 700;
                width: 100%;
                color: #111827;
                line-height: 1.3;
                display: flex;
                align-items: center;
                flex-direction: row;
                justify-content: center;
                gap: 12px;
                position: relative;
            }
            .section-header h2 .back-btn {
                padding: 4px 8px;
                font-size: 0.65rem;
                margin-right: 0;
                min-height: 24px;
                min-width: 28px;
                border-radius: 6px;
                background: linear-gradient(135deg, #347773 0%, #2d6561 100%);
                box-shadow: 0 1px 4px rgba(52, 119, 115, 0.2);
                flex-shrink: 0;
                order: -1;
                position: absolute;
                left: 0;
                z-index: 100;
                pointer-events: auto;
            }
            .section-header h2 .back-btn:active {
                transform: scale(0.95);
                box-shadow: 0 1px 3px rgba(52, 119, 115, 0.25);
            }
            .section-header h2 span {
                flex: 1;
                order: 1;
                text-align: center;
                font-size: 1.875rem;
                font-weight: 700;
                letter-spacing: -0.02em;
                pointer-events: none;
            }
            .section-header > div {
                width: 100%;
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            .section-header button {
                width: 100%;
                padding: 12px;
                font-size: 1rem;
                min-height: 44px; /* Minimum touch target */
            }
            
            /* Buttons - larger touch targets */
            .btn-primary,
            .btn-secondary,
            .btn-danger {
                padding: 12px 20px;
                font-size: 1rem;
                min-height: 44px;
                border-radius: 12px;
                touch-action: manipulation;
            }
            .back-btn {
                padding: 8px 12px;
                font-size: 0.875rem;
                min-height: 36px;
                min-width: 36px;
                border-radius: 10px;
                background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                box-shadow: 0 2px 8px rgba(79, 172, 254, 0.3);
                touch-action: manipulation;
            }
            .back-btn:active {
                transform: scale(0.95);
                box-shadow: 0 1px 4px rgba(79, 172, 254, 0.4);
            }
            
            /* Mobile: materials filters */
            #materials-filters {
                padding: 16px !important;
                border-radius: 16px;
            }
            #materials-filters > div:first-child {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }
            #materials-filters .form-group {
                margin-bottom: 0 !important;
            }
            #materials-filters button {
                width: 100%;
                margin-top: 8px;
                min-height: 44px;
            }
            #materials-stats {
                flex-direction: column;
                gap: 12px !important;
            }
            
            /* Mobile: hide all tables */
            table,
            #materials-content > table,
            #requests-content > table,
            #category-list-content > table,
            #address-list-content > table,
            .section table,
            .modal table {
                display: none !important;
            }
            
            /* Mobile: show cards */
            .mobile-card {
                display: block !important;
            }
            
            /* Enhanced mobile card styling */
            .mobile-card-item {
                background: white;
                border: 1px solid #e5e7eb;
                border-radius: 12px;
                padding: 16px;
                margin-bottom: 12px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                transition: all 0.2s;
            }
            .mobile-card-item:active {
                transform: scale(0.98);
                box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            }
            .mobile-card-item-header {
                font-weight: 700;
                color: #111827;
                font-size: 1.125rem;
                margin-bottom: 12px;
                padding-bottom: 12px;
                border-bottom: 2px solid #f3f4f6;
            }
            .mobile-card-item-row {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                padding: 10px 0;
                border-bottom: 1px solid #f9fafb;
            }
            .mobile-card-item-row:last-of-type {
                border-bottom: none;
            }
            .mobile-card-item-label {
                font-weight: 600;
                color: #667eea;
                min-width: 100px;
                flex-shrink: 0;
                font-size: 0.875rem;
            }
            .mobile-card-item-value {
                color: #374151;
                text-align: right;
                flex: 1;
                word-break: break-word;
                font-size: 0.875rem;
                line-height: 1.5;
            }
            .mobile-card-item-actions {
                display: flex;
                flex-direction: column;
                gap: 8px;
                margin-top: 12px;
                padding-top: 12px;
                border-top: 2px solid #f3f4f6;
            }
            .mobile-card-item-actions button {
                width: 100%;
                padding: 12px;
                min-height: 44px;
                font-size: 0.9375rem;
            }
            
            /* Enhanced form improvements for mobile */
            .form-group {
                margin-bottom: 20px;
            }
            .form-group label {
                font-size: 0.9375rem;
                margin-bottom: 8px;
                color: #374151;
            }
            .form-group input,
            .form-group select,
            .form-group textarea {
                padding: 14px 16px;
                font-size: 16px; /* Prevents zoom on iOS */
                border-radius: 12px;
                border: 2px solid #e5e7eb;
                transition: all 0.2s;
            }
            .form-group input:focus,
            .form-group select:focus,
            .form-group textarea:focus {
                border-color: #667eea;
                outline: none;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }
            .form-row {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            /* Modal improvements */
            .modal-content {
                width: 95%;
                max-width: 95%;
                padding: 20px;
                border-radius: 16px;
                max-height: 85vh;
            }
            .modal-header {
                margin-bottom: 20px;
                padding-bottom: 16px;
            }
            .modal-header h3 {
                font-size: 1.25rem;
            }
            
            /* Empty state styling */
            .empty-state {
                text-align: center;
                padding: 48px 20px;
                color: #666;
                font-size: 0.95rem;
                background: #f8f9fa;
                border-radius: 8px;
                margin: 20px 0;
            }
            
            /* Loading state */
            .loading {
                text-align: center;
                padding: 40px 20px;
                color: #667eea;
                font-size: 1rem;
            }
            .request-item-row,
            .request-item-row-2col {
                grid-template-columns: 1fr;
            }
            .request-item {
                padding: 15px;
            }
            .modal-content {
                width: 95%;
                padding: 20px;
                max-height: 95vh;
            }
            .form-row {
                grid-template-columns: 1fr;
            }
            .btn-primary,
            .btn-secondary,
            .btn-danger {
                width: 100%;
                margin-bottom: 8px;
                padding: 12px;
                font-size: 0.9rem;
            }
            .btn-small {
                padding: 8px 12px;
                font-size: 0.85rem;
            }
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 16px;
                margin-bottom: 28px;
            }
            .stat-card {
                padding: 24px 20px;
                border-radius: 16px;
            }
            .stat-card h3 {
                font-size: 0.8125rem;
                margin-bottom: 14px;
                letter-spacing: 0.7px;
            }
            .stat-number {
                font-size: 2.5rem;
                letter-spacing: -0.8px;
            }
            /* å ±è¡¨ä¸‹è¼‰å€åŸŸåœ¨æ‰‹æ©Ÿç‰ˆä½¿ç”¨å–®åˆ—ä½ˆå±€ */
            #reports-content > div > div:last-child > div {
                grid-template-columns: 1fr !important;
                gap: 16px !important;
            }
            #reports-content > div > div:last-child > div > div {
                min-width: 100% !important;
            }
            .image-upload-area {
                padding: 15px;
            }
            .upload-content {
                font-size: 0.9rem;
            }
            .upload-content div:first-child {
                font-size: 24px !important;
            }
            /* Request detail modal - keep table for items but make it scrollable */
            #request-detail-content table {
                display: table !important;
                font-size: 0.8rem;
                width: 100%;
                overflow-x: auto;
            }
            #request-detail-content table th,
            #request-detail-content table td {
                padding: 8px 4px;
                font-size: 0.75rem;
            }
        }
        
        @media (max-width: 480px) {
            .header {
                padding: 15px;
            }
            .header h1 {
                font-size: 1rem;
            }
            .welcome-card h2 {
                font-size: 1.2rem;
            }
            .welcome-card p {
                font-size: 0.9rem;
            }
            .feature-card {
                padding: 20px;
            }
            .feature-icon {
                font-size: 2rem;
            }
            .modal-content {
                padding: 15px;
            }
            .modal-header h3 {
                font-size: 1.1rem;
            }
            /* Only apply font size to visible tables (detail view) */
            #request-detail-content table {
                font-size: 0.75rem;
            }
            #request-detail-content th, 
            #request-detail-content td {
                padding: 6px 4px;
            }
        }
    </style>

    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default"></head>
<body>
    <div class="header">
        <div class="header-content">
            <h1 onclick="showHome()">å«æ–™ç³»çµ±</h1>
            <div class="user-info">
                <span id="userName">ä½¿ç”¨è€…</span>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Home View -->
        <div id="home-view">
            <div class="welcome-card">
                <h2>å«æ–™ç³»çµ±</h2>
            </div>
            <div class="features">
                <div class="feature-card" onclick="openSection('materials')">
                    <div class="feature-icon">ğŸ“¦</div>
                    <h3>ç‰©æ–™ç®¡ç†</h3>
                    <p>ç®¡ç†ç‰©æ–™è³‡æ–™åº«</p>
                </div>
                <div class="feature-card" onclick="openSection('requests')">
                    <div class="feature-icon">ğŸ“‹</div>
                    <h3>å«æ–™å–®</h3>
                    <p>å»ºç«‹å’Œç®¡ç†å«æ–™å–®</p>
                </div>
                <div class="feature-card" onclick="openSection('reports')">
                    <div class="feature-icon">ğŸ“Š</div>
                    <h3>å ±è¡¨çµ±è¨ˆ</h3>
                    <p>æŸ¥çœ‹å«æ–™çµ±è¨ˆ</p>
                </div>
            </div>
        </div>

        <!-- Materials Section -->
        <div id="materials-section" class="section" style="display: none;">
            <div class="section-header">
                <h2>
                    <button class="back-btn" onclick="showHome()">â†</button>
                    <span>ç‰©æ–™ç®¡ç†</span>
                </h2>
                <div>
                    <button class="btn-secondary" onclick="manageCategories('construction')" style="margin-right: 10px;">ç®¡ç†æ–½å·¥é¡åˆ¥</button>
                    <button class="btn-secondary" onclick="manageCategories('material')" style="margin-right: 10px;">ç®¡ç†ææ–™é¡åˆ¥</button>
                    <button class="btn-secondary" onclick="manageAddresses()" style="margin-right: 10px;">ç®¡ç†åœ°å€</button>
                    <button class="btn-secondary" onclick="manageCompanies()" style="margin-right: 10px;">ç®¡ç†å…¬å¸</button>
                    <button class="btn-primary" onclick="showAddMaterialForm()">æ–°å¢ç‰©æ–™</button>
                </div>
            </div>
            <!-- Materials Filter and Search Bar -->
            <div id="materials-filters" style="display: none; margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 15px; align-items: end; margin-bottom: 15px;">
                    <div class="form-group" style="margin: 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">ğŸ” æœå°‹ç‰©æ–™</label>
                        <input type="text" id="material-search" placeholder="è¼¸å…¥ææ–™åç¨±ã€è¦æ ¼æˆ–å–®ä½..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">æ–½å·¥é¡åˆ¥</label>
                        <select id="filter-construction-category" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: white;">
                            <option value="">å…¨éƒ¨æ–½å·¥é¡åˆ¥</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333;">ææ–™é¡åˆ¥</label>
                        <select id="filter-material-category" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: white;">
                            <option value="">å…¨éƒ¨ææ–™é¡åˆ¥</option>
                        </select>
                    </div>
                    <button type="button" class="btn-secondary" onclick="clearMaterialFilters()" style="padding: 10px 20px; white-space: nowrap;">æ¸…é™¤ç¯©é¸</button>
                </div>
                <div id="materials-stats" style="display: flex; gap: 20px; flex-wrap: wrap; padding-top: 10px; border-top: 1px solid #e0e0e0;">
                    <div style="color: #666; font-size: 14px;">
                        <strong style="color: #667eea;">ç¸½æ•¸ï¼š</strong><span id="total-materials-count">0</span>
                    </div>
                    <div style="color: #666; font-size: 14px;">
                        <strong style="color: #667eea;">é¡¯ç¤ºï¼š</strong><span id="filtered-materials-count">0</span>
                    </div>
                </div>
            </div>
            <div id="materials-content">
                <div class="loading">è¼‰å…¥ä¸­...</div>
            </div>
        </div>

        <!-- Requests Section -->
        <div id="requests-section" class="section" style="display: none;">
            <div class="section-header">
                <h2>
                    <button class="back-btn" onclick="showHome()">â†</button>
                    <span>å«æ–™å–®ç®¡ç†</span>
                </h2>
                <button class="btn-primary" onclick="showCreateRequestForm()">æ–°å¢å«æ–™å–®</button>
            </div>
            <div id="requests-content">
                <div class="loading">è¼‰å…¥ä¸­...</div>
            </div>
        </div>

        <!-- Reports Section -->
        <div id="reports-section" class="section" style="display: none;">
            <div class="section-header">
                <h2>
                    <button class="back-btn" onclick="showHome()">â†</button>
                    <span>å ±è¡¨çµ±è¨ˆ</span>
                </h2>
            </div>
            <div id="reports-content">
                <div class="loading">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- Category Management Modal -->
    <div id="category-manage-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="category-manage-title">ç®¡ç†é¡åˆ¥</h3>
                <button class="close" onclick="closeModal('category-manage-modal')">&times;</button>
            </div>
            <div style="margin-bottom: 15px; text-align: right;">
                <button class="btn-primary" onclick="showAddCategoryForm(currentManageType)">æ–°å¢é¡åˆ¥</button>
            </div>
            <div id="category-list-content">
                <div class="loading">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- Category Form Modal -->
    <div id="category-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="category-modal-title">æ–°å¢é¡åˆ¥</h3>
                <button class="close" onclick="closeModal('category-modal')">&times;</button>
            </div>
            <form id="category-form" onsubmit="saveCategory(event)">
                <div class="form-group">
                    <label>é¡åˆ¥åç¨± *</label>
                    <input type="text" id="category-name" required>
                </div>
                <div class="form-group">
                    <label>æè¿°</label>
                    <textarea id="category-description"></textarea>
                </div>
                <input type="hidden" id="category-type">
                <input type="hidden" id="category-id">
                <div style="text-align: right;">
                    <button type="button" class="btn-secondary" onclick="closeModal('category-modal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn-primary" style="margin-left: 10px;">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Material Form Modal -->
    <div id="material-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="material-modal-title">æ–°å¢ç‰©æ–™</h3>
                <button class="close" onclick="closeModal('material-modal')">&times;</button>
            </div>
            <form id="material-form" onsubmit="saveMaterial(event)">
                <div class="form-group">
                    <label>æ–½å·¥é¡åˆ¥ *</label>
                    <select id="construction-category" required></select>
                </div>
                <div class="form-group">
                    <label>ææ–™é¡åˆ¥ *</label>
                    <select id="material-category" required></select>
                </div>
                <div class="form-group">
                    <label>ææ–™åç¨± *</label>
                    <input type="text" id="material-name" required>
                </div>
                <div class="form-group">
                    <label>ææ–™è¦æ ¼</label>
                    <input type="text" id="material-specification" placeholder="ä¾‹å¦‚ï¼šC30ã€Î¦12mmç­‰">
                </div>
                <div class="form-group">
                    <label>å–®ä½</label>
                    <input type="text" id="material-unit">
                </div>
                <div class="form-group">
                    <label>æè¿°</label>
                    <textarea id="material-description"></textarea>
                </div>
                <div style="text-align: right;">
                    <button type="button" class="btn-secondary" onclick="closeModal('material-modal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn-primary" style="margin-left: 10px;">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Request Form Modal -->
    <div id="request-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ–°å¢å«æ–™å–®</h3>
                <button class="close" onclick="closeModal('request-modal')">&times;</button>
            </div>
            <form id="request-form" onsubmit="saveRequest(event)">
                <div class="form-group">
                    <label>ç”³è«‹äºº *</label>
                    <input type="text" id="request-applicant-name" placeholder="é¸æ“‡åœ°å€å¾Œè‡ªå‹•å¡«å…¥" readonly>
                    <small style="color: #666; font-size: 0.85em; display: block; margin-top: 5px;">å°‡æ ¹æ“šé¸æ“‡çš„é€è²¨åœ°å€è‡ªå‹•å¡«å…¥</small>
                </div>
                <div class="form-group">
                    <label>è¯ç¹«é›»è©± *</label>
                    <input type="tel" id="request-contact-phone" placeholder="é¸æ“‡åœ°å€å¾Œè‡ªå‹•å¡«å…¥" readonly>
                    <small style="color: #666; font-size: 0.85em; display: block; margin-top: 5px;">å°‡æ ¹æ“šé¸æ“‡çš„é€è²¨åœ°å€è‡ªå‹•å¡«å…¥</small>
                </div>
                <div class="form-group">
                    <label>å·¥å€ *</label>
                    <input type="text" id="request-work-area" placeholder="ä¾‹å¦‚ï¼šAå€ã€Bå€" required>
                </div>
                <div class="form-group">
                    <label>æ–½å·¥é¡åˆ¥ *</label>
                    <select id="request-construction-category" required></select>
                </div>
                <div class="form-group">
                    <label>é€è²¨åœ°å€ *</label>
                    <select id="request-delivery-address" required>
                        <option value="">è«‹é¸æ“‡é€è²¨åœ°å€</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å‚™è¨»</label>
                    <textarea id="request-notes"></textarea>
                </div>
                <div class="form-group">
                    <label>ææ–™é …ç›® *</label>
                    <div id="request-items">
                        <div class="request-item">
                            <select class="item-material" required>
                                <option value="">é¸æ“‡ç‰©æ–™</option>
                            </select>
                            <input type="number" class="item-quantity" placeholder="æ•¸é‡" step="1" min="0" oninput="this.value = this.value.replace(/[^0-9]/g, '');" required>
                            <input type="text" class="item-unit" placeholder="å–®ä½" list="unit-history">
                            <input type="text" class="item-notes" placeholder="å‚™è¨»">
                            <input type="url" class="item-image-url" placeholder="åœ–ç‰‡ç¶²å€ï¼ˆå¯é¸ï¼‰">
                            <input type="url" class="item-link-url" placeholder="é€£çµç¶²å€ï¼ˆå¯é¸ï¼‰">
                            <button type="button" class="btn-danger btn-small" onclick="removeRequestItem(this)">åˆªé™¤</button>
                        </div>
                    </div>
                    <datalist id="unit-history"></datalist>
                    <button type="button" class="btn-secondary" onclick="addRequestItem()" style="margin-top: 10px;">æ–°å¢é …ç›®</button>
                </div>
                <div style="text-align: right;">
                    <button type="button" class="btn-secondary" onclick="closeModal('request-modal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn-primary" style="margin-left: 10px;">å»ºç«‹å«æ–™å–®</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Request Detail Modal -->
    <div id="request-detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>å«æ–™å–®è©³æƒ…</h3>
                <button class="close" onclick="closeModal('request-detail-modal')">&times;</button>
            </div>
            <div id="request-detail-content">
                <div class="loading">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- Address Management Modal -->
    <div id="address-manage-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç®¡ç†åœ°å€</h3>
                <button class="close" onclick="closeModal('address-manage-modal')">&times;</button>
            </div>
            <div style="margin-bottom: 15px; text-align: right;">
                <button class="btn-primary" onclick="showAddAddressForm()">æ–°å¢åœ°å€</button>
            </div>
            <div id="address-list-content">
                <div class="loading">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- Address Form Modal -->
    <div id="address-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="address-modal-title">æ–°å¢åœ°å€</h3>
                <button class="close" onclick="closeModal('address-modal')">&times;</button>
            </div>
            <form id="address-form" onsubmit="saveAddress(event)">
                <div class="form-group">
                    <label>åœ°å€åç¨± *</label>
                    <input type="text" id="address-name" placeholder="ä¾‹å¦‚ï¼šç¸½å…¬å¸ã€å·¥åœ°Aå€" required>
                </div>
                <div class="form-group">
                    <label>å®Œæ•´åœ°å€ *</label>
                    <textarea id="address-address" placeholder="è«‹è¼¸å…¥å®Œæ•´åœ°å€" required></textarea>
                </div>
                <div class="form-group">
                    <label>è¯çµ¡äºº</label>
                    <input type="text" id="address-contact-person" placeholder="è«‹è¼¸å…¥è¯çµ¡äººå§“å">
                </div>
                <div class="form-group">
                    <label>è¯çµ¡é›»è©±</label>
                    <input type="tel" id="address-contact-phone" placeholder="è«‹è¼¸å…¥è¯çµ¡é›»è©±">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="address-is-default"> è¨­ç‚ºé è¨­åœ°å€
                    </label>
                </div>
                <input type="hidden" id="address-id">
                <div style="text-align: right;">
                    <button type="button" class="btn-secondary" onclick="closeModal('address-modal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn-primary" style="margin-left: 10px;">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Company Management Modal -->
    <div id="company-manage-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç®¡ç†å…¬å¸</h3>
                <button class="close" onclick="closeModal('company-manage-modal')">&times;</button>
            </div>
            <div style="margin-bottom: 15px; text-align: right;">
                <button class="btn-primary" onclick="showAddCompanyForm()">æ–°å¢å…¬å¸</button>
            </div>
            <div id="company-list-content">
                <div class="loading">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- Company Form Modal -->
    <div id="company-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="company-modal-title">æ–°å¢å…¬å¸</h3>
                <button class="close" onclick="closeModal('company-modal')">&times;</button>
            </div>
            <form id="company-form" onsubmit="saveCompany(event)">
                <input type="hidden" id="company-id">
                <div class="form-group">
                    <label>å…¬å¸åç¨± *</label>
                    <input type="text" id="company-name" placeholder="ä¾‹å¦‚ï¼šABCå»ºè¨­è‚¡ä»½æœ‰é™å…¬å¸" required>
                </div>
                <div class="form-group">
                    <label>çµ±ç·¨ *</label>
                    <input type="text" id="company-tax-id" placeholder="ä¾‹å¦‚ï¼š12345678" required>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="company-is-default"> è¨­ç‚ºé è¨­å…¬å¸
                    </label>
                </div>
                <div class="form-group" style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn-secondary" onclick="closeModal('company-modal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn-primary" style="margin-left: 10px;">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Company Selection Modal -->
    <div id="company-select-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>é¸æ“‡å…¬å¸</h3>
                <button class="close" onclick="closeModal('company-select-modal')">&times;</button>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px;">é¸æ“‡å·²ä¿å­˜çš„å…¬å¸ï¼š</label>
                <select id="company-select-dropdown" style="width: 100%; padding: 8px; margin-bottom: 10px;">
                    <option value="">-- è«‹é¸æ“‡å…¬å¸ --</option>
                </select>
            </div>
            <div style="margin-bottom: 15px; text-align: center; color: #666;">æˆ–</div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px;">å…¬å¸åç¨±ï¼š</label>
                <input type="text" id="company-select-name" placeholder="è¼¸å…¥å…¬å¸åç¨±" style="width: 100%; padding: 8px; margin-bottom: 10px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px;">çµ±ç·¨ï¼š</label>
                <input type="text" id="company-select-tax-id" placeholder="è¼¸å…¥çµ±ç·¨" style="width: 100%; padding: 8px; margin-bottom: 15px;">
            </div>
            <div style="text-align: right;">
                <button type="button" class="btn-secondary" onclick="closeModal('company-select-modal')">å–æ¶ˆ</button>
                <button type="button" class="btn-primary" onclick="confirmCompanySelection()" style="margin-left: 10px;">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <script>
        try {

        let guestToken = null;
        let currentSection = null;
        let allMaterials = [];
        let filteredMaterials = [];
        let constructionCategories = [];
        let materialCategories = [];

        // Safari compatibility check

        // Safari detection and error logging
        var isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        if (isSafari) {
            console.log('Safariç€è¦½å™¨æª¢æ¸¬åˆ°');
            // Add error handler
            window.addEventListener('error', function(e) {
                console.error('SafariéŒ¯èª¤:', e.message, e.filename, e.lineno);
            });
            window.addEventListener('unhandledrejection', function(e) {
                console.error('æœªè™•ç†çš„Promiseæ‹’çµ•:', e.reason);
            });
        }
        if (!window.Promise) {
            console.error('æ­¤ç€è¦½å™¨ä¸æ”¯æ´ Promiseï¼Œè«‹æ›´æ–°ç€è¦½å™¨');
        }
        if (!window.fetch) {
            console.error('æ­¤ç€è¦½å™¨ä¸æ”¯æ´ fetchï¼Œè«‹æ›´æ–°ç€è¦½å™¨');
        }

        // Initialize: Create guest account and get token
        async function init() {
            try {
                const response = await fetch('/api/auth/guest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (response.ok) {
                    const data = await response.json();
                    guestToken = data.token;
                    localStorage.setItem('token', guestToken);
                    console.log('è¨ªå®¢å¸³è™Ÿåˆå§‹åŒ–æˆåŠŸ');
                } else {
                    const errorText = await response.text();
                    console.error('åˆå§‹åŒ–å¤±æ•—:', response.status, errorText);
                    // Try to use existing token from localStorage
                    const existingToken = localStorage.getItem('token');
                    if (existingToken) {
                        guestToken = existingToken;
                        console.log('ä½¿ç”¨ç¾æœ‰çš„ token');
                    }
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–éŒ¯èª¤:', error);
                // Try to use existing token from localStorage
                const existingToken = localStorage.getItem('token');
                if (existingToken) {
                    guestToken = existingToken;
                    console.log('ä½¿ç”¨ç¾æœ‰çš„ token (éŒ¯èª¤å¾Œ)');
                }
            }
        }

        // Refresh token if invalid
        let isRefreshingToken = false;
        async function refreshTokenIfNeeded() {
            if (isRefreshingToken) return;
            isRefreshingToken = true;
            
            try {
                const response = await fetch('/api/auth/guest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                if (response.ok) {
                    const data = await response.json();
                    guestToken = data.token;
                    localStorage.setItem('token', guestToken);
                    console.log('Token å·²åˆ·æ–°');
                }
            } catch (error) {
                console.error('åˆ·æ–° token éŒ¯èª¤:', error);
            } finally {
                isRefreshingToken = false;
            }
        }

        // Get API headers with token
        function getHeaders() {
            const token = guestToken || localStorage.getItem('token');
            if (!token) {
                console.warn('æ²’æœ‰å¯ç”¨çš„ token');
            }
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token || ''}`
            };
        }

        // Show home view
        function showHome() {
            navigateToSection(null);
        }

        // Navigate to section with browser history support
        function navigateToSection(section) {
            // Update display
            if (section === null) {
            document.getElementById('home-view').style.display = 'block';
            ['materials-section', 'requests-section', 'reports-section'].forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
            currentSection = null;
            } else {
            document.getElementById('home-view').style.display = 'none';
            ['materials-section', 'requests-section', 'reports-section'].forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
            
            currentSection = section;
            const sectionEl = document.getElementById(section + '-section');
            sectionEl.style.display = 'block';
            
                // Load section data
            if (section === 'materials') {
                loadMaterials();
                // Setup filters after a short delay to ensure DOM is ready
                setTimeout(() => {
                    setupMaterialFilters();
                }, 100);
            } else if (section === 'requests') {
                loadRequests();
            } else if (section === 'reports') {
                loadReports();
            }
            }
            
            // Update browser history
            const url = section ? `#${section}` : '#';
            if (window.location.hash !== url) {
                if (section === null && window.location.hash) {
                    // Going back to home
                    history.pushState({ section: null }, '', window.location.pathname);
                } else if (section) {
                    // Going to a section
                    history.pushState({ section: section }, '', `#${section}`);
                }
            }
        }

        // Open section
        function openSection(section) {
            navigateToSection(section);
        }

        // Handle browser back/forward buttons
        function handlePopState(event) {
            const section = event.state ? event.state.section : getSectionFromHash();
            navigateToSection(section);
        }

        // Get section from URL hash
        function getSectionFromHash() {
            const hash = window.location.hash.replace('#', '');
            if (hash === 'materials' || hash === 'requests' || hash === 'reports') {
                return hash;
            }
            return null;
        }

        // Load materials
        async function loadMaterials() {
            const content = document.getElementById('materials-content');
            if (!content) {
                console.error('ç„¡æ³•æ‰¾åˆ° materials-content å…ƒç´ ');
                return;
            }
            
            content.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
            
            try {
                const response = await fetch('/api/materials', {
                    headers: getHeaders()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    allMaterials = data.materials || [];
                    filteredMaterials = [...allMaterials];
                    
                    // Load categories for filters
                    await loadCategoriesForFilters();
                    
                    displayMaterials(filteredMaterials);
                    updateMaterialStats();
                } else if (response.status === 401 || response.status === 403) {
                    // Token invalid, try to refresh
                    console.warn('Token ç„¡æ•ˆï¼Œå˜—è©¦åˆ·æ–°...');
                    await refreshTokenIfNeeded();
                    // Retry the request
                    const retryResponse = await fetch('/api/materials', {
                        headers: getHeaders()
                    });
                    if (retryResponse.ok) {
                        const data = await retryResponse.json();
                        allMaterials = data.materials || [];
                        filteredMaterials = [...allMaterials];
                        
                        // Load categories for filters
                        await loadCategoriesForFilters();
                        
                        displayMaterials(filteredMaterials);
                        updateMaterialStats();
                } else {
                        const errorText = await retryResponse.text();
                        let errorMessage = 'ç„¡æ³•è¼‰å…¥ç‰©æ–™è³‡æ–™';
                        try {
                            const errorData = JSON.parse(errorText);
                            errorMessage = errorData.error || errorMessage;
                        } catch (e) {
                            console.error('API éŒ¯èª¤éŸ¿æ‡‰:', errorText);
                        }
                        content.innerHTML = '<div class="alert alert-error">' + escapeHtml(errorMessage) + '</div>';
                    }
                } else {
                    const errorText = await response.text();
                    let errorMessage = 'ç„¡æ³•è¼‰å…¥ç‰©æ–™è³‡æ–™';
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.error || errorMessage;
                    } catch (e) {
                        console.error('API éŒ¯èª¤éŸ¿æ‡‰:', errorText);
                    }
                    content.innerHTML = '<div class="alert alert-error">' + escapeHtml(errorMessage) + '</div>';
                    console.error('è¼‰å…¥ç‰©æ–™å¤±æ•—:', response.status, errorMessage);
                }
            } catch (error) {
                console.error('è¼‰å…¥ç‰©æ–™éŒ¯èª¤:', error);
                content.innerHTML = '<div class="alert alert-error">è¼‰å…¥å¤±æ•—ï¼š' + escapeHtml(error.message || 'æœªçŸ¥éŒ¯èª¤') + '</div>';
            }
        }

        // Load categories for filter dropdowns
        async function loadCategoriesForFilters() {
            try {
                const [ccRes, mcRes] = await Promise.all([
                    fetch('/api/materials/construction-categories', { headers: getHeaders() }),
                    fetch('/api/materials/material-categories', { headers: getHeaders() })
                ]);
                
                if (ccRes.ok && mcRes.ok) {
                    const ccData = await ccRes.json();
                    const mcData = await mcRes.json();
                    
                    constructionCategories = ccData.categories || [];
                    materialCategories = mcData.categories || [];
                    
                    // Populate filter dropdowns
                    const ccFilter = document.getElementById('filter-construction-category');
                    const mcFilter = document.getElementById('filter-material-category');
                    
                    if (ccFilter) {
                        ccFilter.innerHTML = '<option value="">å…¨éƒ¨æ–½å·¥é¡åˆ¥</option>';
                        constructionCategories.forEach(cat => {
                            ccFilter.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
                        });
                    }
                    
                    if (mcFilter) {
                        mcFilter.innerHTML = '<option value="">å…¨éƒ¨ææ–™é¡åˆ¥</option>';
                        materialCategories.forEach(cat => {
                            mcFilter.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
                        });
                    }
                    
                    // Show filters if materials exist
                    const filtersDiv = document.getElementById('materials-filters');
                    if (filtersDiv && allMaterials.length > 0) {
                        filtersDiv.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('è¼‰å…¥é¡åˆ¥éŒ¯èª¤:', error);
            }
        }
        
        // Filter materials based on search and category filters
        function filterMaterials() {
            const searchTerm = (document.getElementById('material-search')?.value || '').toLowerCase().trim();
            const constructionCategoryId = document.getElementById('filter-construction-category')?.value || '';
            const materialCategoryId = document.getElementById('filter-material-category')?.value || '';
            
            filteredMaterials = allMaterials.filter(material => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    (material.name && material.name.toLowerCase().includes(searchTerm)) ||
                    (material.specification && material.specification.toLowerCase().includes(searchTerm)) ||
                    (material.unit && material.unit.toLowerCase().includes(searchTerm)) ||
                    (material.construction_category_name && material.construction_category_name.toLowerCase().includes(searchTerm)) ||
                    (material.material_category_name && material.material_category_name.toLowerCase().includes(searchTerm));
                
                // Construction category filter
                const matchesConstruction = !constructionCategoryId || 
                    material.construction_category_id == constructionCategoryId;
                
                // Material category filter
                const matchesMaterial = !materialCategoryId || 
                    material.material_category_id == materialCategoryId;
                
                return matchesSearch && matchesConstruction && matchesMaterial;
            });
            
            displayMaterials(filteredMaterials);
            updateMaterialStats();
        }
        
        // Clear all filters
        function clearMaterialFilters() {
            document.getElementById('material-search').value = '';
            document.getElementById('filter-construction-category').value = '';
            document.getElementById('filter-material-category').value = '';
            filteredMaterials = [...allMaterials];
            displayMaterials(filteredMaterials);
            updateMaterialStats();
        }
        
        // Update material statistics
        function updateMaterialStats() {
            const totalCount = document.getElementById('total-materials-count');
            const filteredCount = document.getElementById('filtered-materials-count');
            
            if (totalCount) {
                totalCount.textContent = allMaterials.length;
            }
            if (filteredCount) {
                filteredCount.textContent = filteredMaterials.length;
            }
        }
        
        function displayMaterials(materials) {
            const content = document.getElementById('materials-content');
            
            if (!content) {
                console.error('ç„¡æ³•æ‰¾åˆ° materials-content å…ƒç´ ');
                return;
            }
            
            if (materials.length === 0) {
                if (allMaterials.length === 0) {
                    content.innerHTML = '<div class="empty-state">å°šç„¡ç‰©æ–™è³‡æ–™ï¼Œè«‹å…ˆå»ºç«‹é¡åˆ¥ï¼Œç„¶å¾Œé»æ“Šã€Œæ–°å¢ç‰©æ–™ã€é–‹å§‹æ·»åŠ </div>';
                } else {
                    content.innerHTML = '<div class="empty-state">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„ç‰©æ–™ï¼Œè«‹èª¿æ•´ç¯©é¸æ¢ä»¶æˆ–<a href="javascript:clearMaterialFilters()" style="color: #667eea; text-decoration: underline;">æ¸…é™¤ç¯©é¸</a></div>';
                }
                return;
            }
            
            let tableHtml = '<table><thead><tr><th>æ–½å·¥é¡åˆ¥</th><th>ææ–™é¡åˆ¥</th><th>ææ–™åç¨±</th><th>ææ–™è¦æ ¼</th><th>å–®ä½</th><th>æ“ä½œ</th></tr></thead><tbody>';
            let cardHtml = '';
            
            materials.forEach(material => {
                // Desktop table row
                tableHtml += `
                    <tr>
                        <td>${escapeHtml(material.construction_category_name || '-')}</td>
                        <td>${escapeHtml(material.material_category_name || '-')}</td>
                        <td><strong>${escapeHtml(material.name)}</strong></td>
                        <td>${escapeHtml(material.specification || '-')}</td>
                        <td>${escapeHtml(material.unit || '-')}</td>
                        <td>
                            <button class="btn-primary btn-small" onclick="quickAddSpecification(${material.id})" style="margin-right: 5px;">æ–°å¢</button>
                            <button class="btn-secondary btn-small" onclick="editMaterialById(${material.id})" style="margin-right: 5px;">ç·¨è¼¯</button>
                            <button class="btn-danger btn-small" onclick="deleteMaterial(${material.id})">åˆªé™¤</button>
                        </td>
                    </tr>
                `;
                
                // Mobile card
                cardHtml += `
                    <div class="mobile-card-item">
                        <div class="mobile-card-item-header">${escapeHtml(material.name)}</div>
                        <div class="mobile-card-item-row">
                            <span class="mobile-card-item-label">æ–½å·¥é¡åˆ¥</span>
                            <span class="mobile-card-item-value">${escapeHtml(material.construction_category_name || '-')}</span>
                        </div>
                        <div class="mobile-card-item-row">
                            <span class="mobile-card-item-label">ææ–™é¡åˆ¥</span>
                            <span class="mobile-card-item-value">${escapeHtml(material.material_category_name || '-')}</span>
                        </div>
                        <div class="mobile-card-item-row">
                            <span class="mobile-card-item-label">ææ–™è¦æ ¼</span>
                            <span class="mobile-card-item-value">${escapeHtml(material.specification || '-')}</span>
                        </div>
                        <div class="mobile-card-item-row">
                            <span class="mobile-card-item-label">å–®ä½</span>
                            <span class="mobile-card-item-value">${escapeHtml(material.unit || '-')}</span>
                        </div>
                        <div class="mobile-card-item-actions">
                            <button class="btn-primary btn-small" onclick="quickAddSpecification(${material.id})" style="margin-bottom: 5px; width: 100%;">æ–°å¢</button>
                            <button class="btn-secondary btn-small" onclick="editMaterialById(${material.id})" style="margin-right: 5px;">ç·¨è¼¯</button>
                            <button class="btn-danger btn-small" onclick="deleteMaterial(${material.id})">åˆªé™¤</button>
                        </div>
                    </div>
                `;
            });
            
            tableHtml += '</tbody></table>';
            const mobileCardWrapper = cardHtml ? `<div class="mobile-card">${cardHtml}</div>` : '';
            content.innerHTML = tableHtml + mobileCardWrapper;
        }
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            if (text == null) return '-';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        let currentManageType = null;

        // Manage Categories
        async function manageCategories(type) {
            currentManageType = type;
            const content = document.getElementById('category-list-content');
            const title = document.getElementById('category-manage-title');
            title.textContent = type === 'construction' ? 'ç®¡ç†æ–½å·¥é¡åˆ¥' : 'ç®¡ç†ææ–™é¡åˆ¥';
            
            document.getElementById('category-manage-modal').style.display = 'block';
            content.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
            
            try {
                const endpoint = type === 'construction' ? '/api/materials/construction-categories' : '/api/materials/material-categories';
                const response = await fetch(endpoint, {
                    headers: getHeaders()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const categories = data.categories || [];
                    displayCategoryList(categories, type);
                } else {
                    content.innerHTML = '<div class="alert alert-error">ç„¡æ³•è¼‰å…¥é¡åˆ¥è³‡æ–™</div>';
                }
            } catch (error) {
                content.innerHTML = '<div class="alert alert-error">è¼‰å…¥å¤±æ•—ï¼š' + error.message + '</div>';
            }
        }

        function displayCategoryList(categories, type) {
            const content = document.getElementById('category-list-content');
            
            if (!content) {
                console.error('ç„¡æ³•æ‰¾åˆ° category-list-content å…ƒç´ ');
                return;
            }
            
            if (categories.length === 0) {
                content.innerHTML = '<div class="empty-state">å°šç„¡é¡åˆ¥ï¼Œè«‹é»æ“Šã€Œæ–°å¢é¡åˆ¥ã€</div>';
                return;
            }
            
            let tableHtml = '<table><thead><tr><th>åç¨±</th><th>æè¿°</th><th>æ“ä½œ</th></tr></thead><tbody>';
            let cardHtml = '<div class="mobile-card">';
            
            categories.forEach(cat => {
                // Desktop table row
                tableHtml += `
                    <tr>
                        <td>${escapeHtml(cat.name)}</td>
                        <td>${escapeHtml(cat.description || '-')}</td>
                        <td>
                            <button class="btn-secondary btn-small" onclick="editCategoryById(${cat.id}, '${type}')" style="margin-right: 5px;">ç·¨è¼¯</button>
                            <button class="btn-danger btn-small" onclick="deleteCategory(${cat.id}, '${type}')">åˆªé™¤</button>
                        </td>
                    </tr>
                `;
                
                // Mobile card
                cardHtml += `
                    <div class="mobile-card-item">
                        <div class="mobile-card-item-header">${escapeHtml(cat.name)}</div>
                        <div class="mobile-card-item-row">
                            <span class="mobile-card-item-label">æè¿°</span>
                            <span class="mobile-card-item-value">${escapeHtml(cat.description || '-')}</span>
                        </div>
                        <div class="mobile-card-item-actions">
                            <button class="btn-secondary btn-small" onclick="editCategoryById(${cat.id}, '${type}')">ç·¨è¼¯</button>
                            <button class="btn-danger btn-small" onclick="deleteCategory(${cat.id}, '${type}')">åˆªé™¤</button>
                        </div>
                    </div>
                `;
            });
            
            tableHtml += '</tbody></table>';
            cardHtml += '</div>';
            content.innerHTML = tableHtml + cardHtml;
        }

        // Show add category form (also handles edit setup)
        function showAddCategoryForm(type) {
            const modalTitle = document.getElementById('category-modal-title');
            modalTitle.textContent = type === 'construction' ? 'æ–°å¢æ–½å·¥é¡åˆ¥' : 'æ–°å¢ææ–™é¡åˆ¥';
            document.getElementById('category-type').value = type;
            document.getElementById('category-id').value = ''; // Clear ID for new
            document.getElementById('category-name').value = '';
            document.getElementById('category-description').value = '';
            document.getElementById('category-modal').style.display = 'block';
        }

        // Edit Category by ID (get from current list)
        function editCategoryById(id, type) {
            // Get category from current list
            const endpoint = type === 'construction' ? '/api/materials/construction-categories' : '/api/materials/material-categories';
            
            fetch(endpoint, { headers: getHeaders() })
                .then(response => response.json())
                .then(data => {
                    const cat = data.categories.find(c => c.id == id);
                    if (!cat) {
                        alert('æ‰¾ä¸åˆ°é¡åˆ¥è³‡æ–™');
                        return;
                    }
                    
                    const modalTitle = document.getElementById('category-modal-title');
                    modalTitle.textContent = type === 'construction' ? 'ç·¨è¼¯æ–½å·¥é¡åˆ¥' : 'ç·¨è¼¯ææ–™é¡åˆ¥';
                    
                    document.getElementById('category-type').value = type;
                    document.getElementById('category-id').value = cat.id;
                    document.getElementById('category-name').value = cat.name;
                    document.getElementById('category-description').value = cat.description || '';
                    document.getElementById('category-modal').style.display = 'block';
                })
                .catch(error => {
                    alert('è¼‰å…¥é¡åˆ¥è³‡æ–™å¤±æ•—ï¼š' + error.message);
                });
        }

        // Delete Category
        async function deleteCategory(id, type) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é¡åˆ¥å—ï¼Ÿå¦‚æœæ­¤é¡åˆ¥ä¸‹æœ‰ç‰©æ–™ï¼Œå°‡ç„¡æ³•åˆªé™¤ã€‚')) return;
            
            try {
                const endpoint = type === 'construction' ? 
                    `/api/materials/construction-categories/${id}` : 
                    `/api/materials/material-categories/${id}`;
                    
                const response = await fetch(endpoint, {
                    method: 'DELETE',
                    headers: getHeaders()
                });
                
                if (response.ok) {
                    manageCategories(type); // Refresh list
                } else {
                    const error = await response.json();
                    alert('åˆªé™¤å¤±æ•—ï¼š' + (error.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                alert('åˆªé™¤å¤±æ•—ï¼š' + error.message);
            }
        }

        // Save category (Create or Update)
        async function saveCategory(e) {
            e.preventDefault();
            
            const type = document.getElementById('category-type').value;
            const id = document.getElementById('category-id').value;
            const name = document.getElementById('category-name').value;
            const description = document.getElementById('category-description').value || null;
            
            let endpoint = type === 'construction' ? '/api/materials/construction-categories' : '/api/materials/material-categories';
            let method = 'POST';
            
            if (id) {
                endpoint += `/${id}`;
                method = 'PUT';
            }
            
            try {
                const response = await fetch(endpoint, {
                    method: method,
                    headers: getHeaders(),
                    body: JSON.stringify({ name, description })
                });
                
                if (response.ok) {
                    closeModal('category-modal');
                    if (document.getElementById('category-manage-modal').style.display === 'block') {
                        manageCategories(type); // Refresh manage list
                    }
                    if (currentSection === 'materials') {
                        loadMaterials();
                    }
                    alert(id ? 'é¡åˆ¥æ›´æ–°æˆåŠŸï¼' : 'é¡åˆ¥å»ºç«‹æˆåŠŸï¼');
                } else {
                    const error = await response.json();
                    alert('å„²å­˜å¤±æ•—ï¼š' + (error.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                alert('å„²å­˜å¤±æ•—ï¼š' + error.message);
            }
        }

        // Show add material form
        async function showAddMaterialForm() {
            document.getElementById('material-modal-title').textContent = 'æ–°å¢ç‰©æ–™';
            document.getElementById('material-form').reset();
            document.getElementById('material-form').setAttribute('data-material-id', ''); // Clear ID
            
            // Enable all fields for new material
            document.getElementById('construction-category').disabled = false;
            document.getElementById('material-category').disabled = false;
            document.getElementById('material-name').disabled = false;
            
            await loadCategoriesForMaterialForm();
            document.getElementById('material-modal').style.display = 'block';
        }

        // Quick add specification - create new material with same category and name but different specification
        async function quickAddSpecification(id) {
            try {
                const response = await fetch(`/api/materials/${id}`, {
                    headers: getHeaders()
                });
                
                if (!response.ok) {
                    alert('ç„¡æ³•è¼‰å…¥ç‰©æ–™è³‡æ–™');
                    return;
                }
                
                const data = await response.json();
                const material = data.material;
                
                document.getElementById('material-modal-title').textContent = 'æ–°å¢ç‰©æ–™ï¼ˆç›¸åŒé¡åˆ¥å’Œåç¨±ï¼‰';
                document.getElementById('material-form').setAttribute('data-material-id', ''); // Clear ID for new material
                
                const loaded = await loadCategoriesForMaterialForm();
                if (!loaded) return;
                
                // Pre-fill form with existing material's category, name, and unit
                document.getElementById('construction-category').value = material.construction_category_id;
                document.getElementById('material-category').value = material.material_category_id;
                document.getElementById('material-name').value = material.name;
                // Pre-fill unit if exists
                document.getElementById('material-unit').value = material.unit || '';
                // Clear specification for new entry (user must input different specification)
                document.getElementById('material-specification').value = '';
                // Clear description
                document.getElementById('material-description').value = '';
                
                // Use readonly instead of disabled for select elements (disabled values are not submitted)
                // For select elements, we'll keep them enabled but add visual indication
                // For input elements, use readonly attribute
                const nameInput = document.getElementById('material-name');
                nameInput.readOnly = true;
                nameInput.style.backgroundColor = '#f5f5f5';
                nameInput.style.cursor = 'not-allowed';
                
                // For select elements, we can't use readonly, so we'll keep them enabled
                // but add a visual style to indicate they're locked
                const constructionSelect = document.getElementById('construction-category');
                const materialSelect = document.getElementById('material-category');
                constructionSelect.style.backgroundColor = '#f5f5f5';
                materialSelect.style.backgroundColor = '#f5f5f5';
                
                // Focus on specification input
                document.getElementById('material-modal').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('material-specification').focus();
                }, 100);
            } catch (error) {
                alert('è¼‰å…¥ç‰©æ–™è³‡æ–™å¤±æ•—ï¼š' + error.message);
            }
        }

        // Edit Material by ID
        async function editMaterialById(id) {
            try {
                const response = await fetch(`/api/materials/${id}`, {
                    headers: getHeaders()
                });
                
                if (!response.ok) {
                    alert('ç„¡æ³•è¼‰å…¥ç‰©æ–™è³‡æ–™');
                    return;
                }
                
                const data = await response.json();
                const material = data.material;
                
                document.getElementById('material-modal-title').textContent = 'ç·¨è¼¯ç‰©æ–™';
                document.getElementById('material-form').setAttribute('data-material-id', material.id);
                
                const loaded = await loadCategoriesForMaterialForm();
                if (!loaded) return;
                
                // Enable all fields for editing
                const nameInput = document.getElementById('material-name');
                nameInput.readOnly = false;
                nameInput.style.backgroundColor = '';
                nameInput.style.cursor = '';
                
                const constructionSelect = document.getElementById('construction-category');
                const materialSelect = document.getElementById('material-category');
                constructionSelect.style.backgroundColor = '';
                materialSelect.style.backgroundColor = '';
                
                // Set form values
                document.getElementById('construction-category').value = material.construction_category_id;
                document.getElementById('material-category').value = material.material_category_id;
                document.getElementById('material-name').value = material.name;
                document.getElementById('material-specification').value = material.specification || '';
                document.getElementById('material-unit').value = material.unit || '';
                document.getElementById('material-description').value = material.description || '';
                
                document.getElementById('material-modal').style.display = 'block';
            } catch (error) {
                alert('è¼‰å…¥ç‰©æ–™è³‡æ–™å¤±æ•—ï¼š' + error.message);
            }
        }

        // Load categories for material form
        async function loadCategoriesForMaterialForm() {
            try {
                const [ccRes, mcRes] = await Promise.all([
                    fetch('/api/materials/construction-categories', { headers: getHeaders() }),
                    fetch('/api/materials/material-categories', { headers: getHeaders() })
                ]);
                
                if (ccRes.ok && mcRes.ok) {
                    const ccData = await ccRes.json();
                    const mcData = await mcRes.json();
                    
                    const ccSelect = document.getElementById('construction-category');
                    const mcSelect = document.getElementById('material-category');
                    
                    ccSelect.innerHTML = '<option value="">é¸æ“‡æ–½å·¥é¡åˆ¥</option>';
                    ccData.categories.forEach(cat => {
                        ccSelect.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
                    });
                    
                    mcSelect.innerHTML = '<option value="">é¸æ“‡ææ–™é¡åˆ¥</option>';
                    mcData.categories.forEach(cat => {
                        mcSelect.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
                    });
                } else {
                    alert('ç„¡æ³•è¼‰å…¥é¡åˆ¥è³‡æ–™ï¼Œè«‹å…ˆå»ºç«‹é¡åˆ¥');
                    return false;
                }
            } catch (error) {
                console.error('è¼‰å…¥é¡åˆ¥éŒ¯èª¤:', error);
                alert('ç„¡æ³•è¼‰å…¥é¡åˆ¥è³‡æ–™');
                return false;
            }
            return true;
        }

        // Save material (Create or Update)
        async function saveMaterial(e) {
            e.preventDefault();
            
            const materialId = document.getElementById('material-form').getAttribute('data-material-id');
            
            // Get values directly (fields are now readonly instead of disabled)
            const constructionCategoryEl = document.getElementById('construction-category');
            const materialCategoryEl = document.getElementById('material-category');
            const materialNameEl = document.getElementById('material-name');
            const specificationEl = document.getElementById('material-specification');
            const unitEl = document.getElementById('material-unit');
            const descriptionEl = document.getElementById('material-description');
            
            const construction_category_id = parseInt(constructionCategoryEl.value, 10);
            const material_category_id = parseInt(materialCategoryEl.value, 10);
            const name = materialNameEl.value.trim();
            const specification = specificationEl.value.trim() || null;
            const unit = unitEl.value.trim() || null;
            const description = descriptionEl.value.trim() || null;
            
            // Validate required fields with detailed error messages
            const errors = [];
            if (isNaN(construction_category_id) || construction_category_id <= 0) {
                errors.push('æ–½å·¥é¡åˆ¥');
            }
            if (isNaN(material_category_id) || material_category_id <= 0) {
                errors.push('ææ–™é¡åˆ¥');
            }
            if (!name || name.length === 0) {
                errors.push('ææ–™åç¨±');
            }
            
            if (errors.length > 0) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½ï¼š' + errors.join('ã€'));
                console.error('é©—è­‰å¤±æ•—ï¼Œç¼ºå°‘æ¬„ä½ï¼š', errors);
                console.error('ç•¶å‰å€¼ï¼š', {
                    construction_category_id,
                    material_category_id,
                    name,
                    constructionCategoryValue: constructionCategoryEl.value,
                    materialCategoryValue: materialCategoryEl.value,
                    nameValue: materialNameEl.value
                });
                return;
            }
            
            const material = {
                construction_category_id,
                material_category_id,
                name,
                specification,
                unit,
                description
            };
            
            let endpoint = '/api/materials';
            let method = 'POST';
            
            if (materialId) {
                endpoint += `/${materialId}`;
                method = 'PUT';
            }
            
            try {
                console.log('æº–å‚™å„²å­˜ç‰©æ–™ï¼Œè³‡æ–™ï¼š', material);
                
                const response = await fetch(endpoint, {
                    method: method,
                    headers: getHeaders(),
                    body: JSON.stringify(material)
                });
                
                const responseData = await response.json();
                console.log('ä¼ºæœå™¨å›æ‡‰ï¼š', response.status, responseData);
                
                if (response.ok) {
                    closeModal('material-modal');
                    await loadMaterials();
                    alert(materialId ? 'ç‰©æ–™æ›´æ–°æˆåŠŸï¼' : 'ç‰©æ–™å»ºç«‹æˆåŠŸï¼');
                } else {
                    const errorMsg = responseData.error || responseData.details || 'æœªçŸ¥éŒ¯èª¤';
                    console.error('å„²å­˜å¤±æ•—ï¼š', errorMsg, responseData);
                    alert('å„²å­˜å¤±æ•—ï¼š' + errorMsg + (responseData.details ? '\nè©³æƒ…ï¼š' + responseData.details : ''));
                }
            } catch (error) {
                console.error('å„²å­˜ç‰©æ–™ç™¼ç”ŸéŒ¯èª¤ï¼š', error);
                alert('å„²å­˜å¤±æ•—ï¼š' + (error.message || 'ç¶²è·¯éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥é€£ç·š'));
            }
        }

        // Delete material
        async function deleteMaterial(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç‰©æ–™å—ï¼Ÿå¦‚æœæ­¤ç‰©æ–™å·²è¢«ä½¿ç”¨ï¼Œå°‡ç„¡æ³•åˆªé™¤ã€‚')) return;
            
            try {
                const response = await fetch(`/api/materials/${id}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });
                
                if (response.ok) {
                    await loadMaterials();
                    alert('ç‰©æ–™å·²åˆªé™¤');
                } else {
                    const error = await response.json();
                    alert('åˆªé™¤å¤±æ•—ï¼š' + (error.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                alert('åˆªé™¤å¤±æ•—ï¼š' + error.message);
            }
        }

        // Load requests
        async function loadRequests() {
            const content = document.getElementById('requests-content');
            content.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
            
            try {
                const response = await fetch('/api/requests', {
                    headers: getHeaders()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayRequests(data.requests || []);
                } else {
                    content.innerHTML = '<div class="alert alert-error">ç„¡æ³•è¼‰å…¥å«æ–™å–®è³‡æ–™</div>';
                }
            } catch (error) {
                content.innerHTML = '<div class="alert alert-error">è¼‰å…¥å¤±æ•—ï¼š' + error.message + '</div>';
            }
        }

        // Format date to minute precision
        function formatDateTimeToMinute(dateString) {
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}/${month}/${day} ${hours}:${minutes}`;
        }

        function displayRequests(requests) {
            const content = document.getElementById('requests-content');
            
            if (!content) {
                console.error('ç„¡æ³•æ‰¾åˆ° requests-content å…ƒç´ ');
                return;
            }
            
            if (requests.length === 0) {
                content.innerHTML = '<div class="empty-state">å°šç„¡å«æ–™å–®ï¼Œè«‹é»æ“Šã€Œæ–°å¢å«æ–™å–®ã€é–‹å§‹å‰µå»º</div>';
                return;
            }
            
            let tableHtml = '<table><thead><tr><th>å–®è™Ÿ</th><th>å·¥å€</th><th>æ–½å·¥é¡åˆ¥</th><th>ææ–™åç¨±</th><th>æ•¸é‡</th><th>æ“ä½œ</th></tr></thead><tbody>';
            let cardHtml = '<div class="mobile-card">';
            
            requests.forEach(request => {
                // Desktop table row
                tableHtml += `
                    <tr>
                        <td>${escapeHtml(request.request_number)}</td>
                        <td>${escapeHtml(request.work_area || '-')}</td>
                        <td>${escapeHtml(request.construction_category_name || '-')}</td>
                        <td>${escapeHtml(request.first_material_name || '-')}</td>
                        <td>${escapeHtml(Math.floor(request.first_material_quantity || 0))}</td>
                        <td>
                            <button class="btn-secondary" onclick="viewRequest(${request.id})" style="margin-right: 5px;">æŸ¥çœ‹</button>
                            <button class="btn-primary" onclick="sendRequestEmail(${request.id})" style="margin-right: 5px;">ğŸ“§ ç™¼é€éƒµä»¶</button>
                            <button class="btn-primary" onclick="downloadRequestExcel(${request.id})" style="margin-right: 5px;">ğŸ“¥ ä¸‹è¼‰Excel</button>
                            <button class="btn-danger" onclick="deleteRequest(${request.id})">ğŸ—‘ï¸ åˆªé™¤</button>
                        </td>
                    </tr>
                `;
                
                // Mobile card
                cardHtml += `
                    <div class="mobile-card-item">
                        <div class="mobile-card-item-header">${escapeHtml(request.request_number)}</div>
                        <div class="mobile-card-item-row">
                            <span class="mobile-card-item-label">å·¥å€</span>
                            <span class="mobile-card-item-value">${escapeHtml(request.work_area || '-')}</span>
                        </div>
                        <div class="mobile-card-item-row">
                            <span class="mobile-card-item-label">æ–½å·¥é¡åˆ¥</span>
                            <span class="mobile-card-item-value">${escapeHtml(request.construction_category_name || '-')}</span>
                        </div>
                        <div class="mobile-card-item-row">
                            <span class="mobile-card-item-label">ææ–™åç¨±</span>
                            <span class="mobile-card-item-value">${escapeHtml(request.first_material_name || '-')}</span>
                        </div>
                        <div class="mobile-card-item-row">
                            <span class="mobile-card-item-label">æ•¸é‡</span>
                            <span class="mobile-card-item-value">${escapeHtml(Math.floor(request.first_material_quantity || 0))}</span>
                        </div>
                        <div class="mobile-card-item-actions">
                            <button class="btn-secondary" onclick="viewRequest(${request.id})">æŸ¥çœ‹</button>
                            <button class="btn-primary" onclick="sendRequestEmail(${request.id})">ğŸ“§ ç™¼é€éƒµä»¶</button>
                            <button class="btn-primary" onclick="downloadRequestExcel(${request.id})">ğŸ“¥ ä¸‹è¼‰Excel</button>
                            <button class="btn-danger" onclick="deleteRequest(${request.id})">ğŸ—‘ï¸ åˆªé™¤</button>
                        </div>
                    </div>
                `;
            });
            
            tableHtml += '</tbody></table>';
            cardHtml += '</div>';
            content.innerHTML = tableHtml + cardHtml;
        }

        // Show create request form
        async function showCreateRequestForm() {
            document.getElementById('request-form').reset();
            
            // Clear applicant name and contact phone fields
            document.getElementById('request-applicant-name').value = '';
            document.getElementById('request-contact-phone').value = '';
            
            // Load construction categories
            try {
                const ccRes = await fetch('/api/materials/construction-categories', { headers: getHeaders() });
                if (ccRes.ok) {
                    const ccData = await ccRes.json();
                    const ccSelect = document.getElementById('request-construction-category');
                    ccSelect.innerHTML = '<option value="">é¸æ“‡æ–½å·¥é¡åˆ¥</option>';
                    ccData.categories.forEach(cat => {
                        ccSelect.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
                    });
                }
            } catch (error) {
                alert('ç„¡æ³•è¼‰å…¥æ–½å·¥é¡åˆ¥');
                return;
            }
            
            // Load delivery addresses
            await loadDeliveryAddresses();
            
            // Load materials
            try {
                const matRes = await fetch('/api/materials', { headers: getHeaders() });
                if (matRes.ok) {
                    const matData = await matRes.json();
                    allMaterials = matData.materials || [];
                    
                    // Reset items
                    const itemsContainer = document.getElementById('request-items');
                    itemsContainer.innerHTML = `
                        <div class="request-item" data-item-index="0">
                            <div class="request-item-row">
                                <select class="item-material" required>
                                    <option value="">è«‹å…ˆé¸æ“‡æ–½å·¥é¡åˆ¥</option>
                                </select>
                                <input type="number" class="item-quantity" placeholder="æ•¸é‡" step="1" min="0" oninput="this.value = this.value.replace(/[^0-9]/g, '');" required>
                                <input type="text" class="item-unit" id="unit-input-0" placeholder="å–®ä½" list="unit-history">
                            </div>
                            <div class="request-item-row-full">
                                <input type="text" class="item-notes" placeholder="å‚™è¨»ï¼ˆå¯é¸ï¼‰">
                            </div>
                            <div class="request-item-row-2col">
                                <div class="image-upload-area" data-item-index="0">
                                    <input type="file" class="item-image-file" accept="image/*" onchange="handleImageUpload(this, 0)">
                                    <div class="upload-content">
                                        <div style="font-size: 32px; margin-bottom: 8px;">ğŸ“·</div>
                                        <div style="color: #667eea; font-weight: 500;">é»æ“Šé¸æ“‡åœ–ç‰‡</div>
                                        <div style="color: #94a3b8; font-size: 12px; margin-top: 4px;">æ”¯æ´ JPGã€PNGã€GIFï¼ˆæœ€å¤§ 10MBï¼‰</div>
                                    </div>
                                    <div class="image-preview-container" style="display: none;">
                                        <img class="image-preview" src="" alt="é è¦½">
                                        <button type="button" class="remove-image-btn" onclick="removeImage(0)">Ã—</button>
                                    </div>
                                    <input type="hidden" class="item-image-url" value="">
                                </div>
                                <div class="link-input-group">
                                    <span class="link-icon">ğŸ”—</span>
                                    <input type="url" class="item-link-url" placeholder="è¼¸å…¥é€£çµç¶²å€ï¼ˆå¯é¸ï¼‰">
                                </div>
                            </div>
                            <div style="text-align: right; margin-top: 10px;">
                                <button type="button" class="btn-danger btn-small" onclick="removeRequestItem(this)">åˆªé™¤é …ç›®</button>
                            </div>
                        </div>
                    `;
                    
                    // Add event listener for construction category change
                    const constructionCategorySelect = document.getElementById('request-construction-category');
                    constructionCategorySelect.addEventListener('change', function() {
                        filterMaterialsByCategory(parseInt(this.value));
                    });
                    
                    // Add event listener for unit auto-fill
                    itemsContainer.querySelectorAll('.item-material').forEach(select => {
                        select.addEventListener('change', function() {
                            const unit = this.options[this.selectedIndex].dataset.unit;
                            const unitInput = this.closest('.request-item').querySelector('.item-unit');
                            if (unit) unitInput.value = unit;
                        });
                    });
                    
                    // Setup unit history for the first item
                    const firstUnitInput = itemsContainer.querySelector('.item-unit');
                    if (firstUnitInput) {
                        firstUnitInput.id = 'unit-input-0';
                        setupUnitHistory(firstUnitInput);
                    }
                    
                    // Setup quantity validation for all quantity inputs
                    itemsContainer.querySelectorAll('.item-quantity').forEach(input => {
                        setupQuantityValidation(input);
                    });
                }
            } catch (error) {
                alert('ç„¡æ³•è¼‰å…¥ç‰©æ–™è³‡æ–™');
                return;
            }
            
            document.getElementById('request-modal').style.display = 'block';
        }

        // Filter materials by construction category
        function filterMaterialsByCategory(constructionCategoryId) {
            if (!constructionCategoryId) {
                // If no category selected, show message
                document.querySelectorAll('.item-material').forEach(select => {
                    select.innerHTML = '<option value="">è«‹å…ˆé¸æ“‡æ–½å·¥é¡åˆ¥</option>';
                });
                return;
            }
            
            // Filter materials by construction category
            const filteredMaterials = allMaterials.filter(m => m.construction_category_id === constructionCategoryId);
            
            // Update all material selects
            document.querySelectorAll('.item-material').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">é¸æ“‡ç‰©æ–™</option>';
                
                filteredMaterials.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m.id;
                    option.setAttribute('data-unit', m.unit || '');
                    option.setAttribute('data-construction-category-id', m.construction_category_id);
                    const specText = m.specification ? ` (${m.specification})` : '';
                    option.textContent = `${m.material_category_name || ''} - ${m.name}${specText}`;
                    select.appendChild(option);
                });
                
                // Restore previous selection if it still exists
                if (currentValue) {
                    const option = select.querySelector(`option[value="${currentValue}"]`);
                    if (option) {
                        select.value = currentValue;
                    }
                }
            });
        }
        
        // Add request item
        function addRequestItem() {
            const itemsContainer = document.getElementById('request-items');
            const itemCount = itemsContainer.children.length;
            const constructionCategoryId = parseInt(document.getElementById('request-construction-category').value) || null;
            
            const newItem = document.createElement('div');
            newItem.className = 'request-item';
            newItem.setAttribute('data-item-index', itemCount.toString());
            
            // Get filtered materials
            let materialOptions = '<option value="">é¸æ“‡ç‰©æ–™</option>';
            if (constructionCategoryId) {
                const filteredMaterials = allMaterials.filter(m => m.construction_category_id === constructionCategoryId);
                filteredMaterials.forEach(m => {
                    const specText = m.specification ? ` (${m.specification})` : '';
                    materialOptions += `<option value="${m.id}" data-unit="${m.unit || ''}" data-construction-category-id="${m.construction_category_id}">${m.material_category_name || ''} - ${m.name}${specText}</option>`;
                });
            } else {
                materialOptions = '<option value="">è«‹å…ˆé¸æ“‡æ–½å·¥é¡åˆ¥</option>';
            }
            
            newItem.innerHTML = `
                <div class="request-item-row">
                    <select class="item-material" required>
                        ${materialOptions}
                    </select>
                                <input type="number" class="item-quantity" placeholder="æ•¸é‡" step="1" min="0" oninput="this.value = this.value.replace(/[^0-9]/g, '');" required>
                    <input type="text" class="item-unit" id="unit-input-${itemCount}" placeholder="å–®ä½" list="unit-history">
                </div>
                <div class="request-item-row-full">
                    <input type="text" class="item-notes" placeholder="å‚™è¨»ï¼ˆå¯é¸ï¼‰">
                </div>
                <div class="request-item-row-2col">
                    <div class="image-upload-area" data-item-index="${itemCount}">
                        <input type="file" class="item-image-file" accept="image/*" onchange="handleImageUpload(this, ${itemCount})">
                        <div class="upload-content">
                            <div style="font-size: 32px; margin-bottom: 8px;">ğŸ“·</div>
                            <div style="color: #667eea; font-weight: 500;">é»æ“Šé¸æ“‡åœ–ç‰‡</div>
                            <div style="color: #94a3b8; font-size: 12px; margin-top: 4px;">æ”¯æ´ JPGã€PNGã€GIFï¼ˆæœ€å¤§ 10MBï¼‰</div>
                        </div>
                        <div class="image-preview-container" style="display: none;">
                            <img class="image-preview" src="" alt="é è¦½">
                            <button type="button" class="remove-image-btn" onclick="removeImage(${itemCount})">Ã—</button>
                        </div>
                        <input type="hidden" class="item-image-url" value="">
                    </div>
                    <div class="link-input-group">
                        <span class="link-icon">ğŸ”—</span>
                        <input type="url" class="item-link-url" placeholder="è¼¸å…¥é€£çµç¶²å€ï¼ˆå¯é¸ï¼‰">
                    </div>
                </div>
                <div style="text-align: right; margin-top: 10px;">
                    <button type="button" class="btn-danger btn-small" onclick="removeRequestItem(this)">åˆªé™¤é …ç›®</button>
                </div>
            `;
            itemsContainer.appendChild(newItem);
            
            // Add event listener for unit auto-fill
            newItem.querySelector('.item-material').addEventListener('change', function() {
                const unit = this.options[this.selectedIndex].dataset.unit;
                const unitInput = this.closest('.request-item').querySelector('.item-unit');
                if (unit) unitInput.value = unit;
            });
            
            // Setup unit history for this input
            setupUnitHistory(newItem.querySelector('.item-unit'));
            
            // Setup quantity validation for the new quantity input
            setupQuantityValidation(newItem.querySelector('.item-quantity'));
        }
        
        // Handle image upload
        async function handleImageUpload(input, itemIndex) {
            const file = input.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('è«‹é¸æ“‡åœ–ç‰‡æª”æ¡ˆ');
                input.value = '';
                return;
            }
            
            // Validate file size (10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é 10MB');
                input.value = '';
                return;
            }
            
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const uploadArea = input.closest('.image-upload-area');
                const previewContainer = uploadArea.querySelector('.image-preview-container');
                const previewImg = uploadArea.querySelector('.image-preview');
                const uploadContent = uploadArea.querySelector('.upload-content');
                
                previewImg.src = e.target.result;
                previewContainer.style.display = 'block';
                uploadContent.style.display = 'none';
            };
            reader.readAsDataURL(file);
            
            // Upload to server
            try {
                const formData = new FormData();
                formData.append('image', file);
                
                const token = guestToken || localStorage.getItem('token');
                const response = await fetch('/api/uploads/image', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const imageUrlInput = input.closest('.image-upload-area').querySelector('.item-image-url');
                    imageUrlInput.value = data.url;
                } else {
                    const error = await response.json();
                    alert('ä¸Šå‚³å¤±æ•—ï¼š' + (error.error || 'æœªçŸ¥éŒ¯èª¤'));
                    removeImage(itemIndex);
                }
            } catch (error) {
                alert('ä¸Šå‚³å¤±æ•—ï¼š' + error.message);
                removeImage(itemIndex);
            }
        }
        
        // Remove image
        function removeImage(itemIndex) {
            const item = document.querySelector(`.request-item[data-item-index="${itemIndex}"]`);
            if (!item) return;
            
            const uploadArea = item.querySelector('.image-upload-area');
            const previewContainer = uploadArea.querySelector('.image-preview-container');
            const uploadContent = uploadArea.querySelector('.upload-content');
            const fileInput = uploadArea.querySelector('.item-image-file');
            const imageUrlInput = uploadArea.querySelector('.item-image-url');
            
            previewContainer.style.display = 'none';
            uploadContent.style.display = 'block';
            fileInput.value = '';
            imageUrlInput.value = '';
        }
        

        // Remove request item
        function removeRequestItem(btn) {
            const itemsContainer = document.getElementById('request-items');
            if (itemsContainer.children.length > 1) {
                btn.closest('.request-item').remove();
            } else {
                alert('è‡³å°‘éœ€è¦ä¸€å€‹ææ–™é …ç›®');
            }
        }

        // Setup quantity validation - ensure non-negative integer only
        function setupQuantityValidation(input) {
            if (!input) return;
            
            input.addEventListener('blur', function() {
                const value = parseInt(this.value, 10);
                if (isNaN(value) || value < 0) {
                    this.value = 0;
                } else {
                    // Ensure no decimal point
                    this.value = Math.floor(value);
                }
            });
            
            // Prevent decimal point and negative sign input
            input.addEventListener('keydown', function(e) {
                if (e.key === '.' || e.key === ',' || e.key === 'e' || e.key === 'E' || e.key === '+' || e.key === '-') {
                    e.preventDefault();
                }
            });
            
            // Remove decimal point and negative sign on paste
            input.addEventListener('paste', function(e) {
                e.preventDefault();
                const pastedText = (e.clipboardData || window.clipboardData).getData('text');
                const cleanValue = pastedText.replace(/[^0-9]/g, '');
                const intValue = parseInt(cleanValue, 10);
                if (!isNaN(intValue) && intValue >= 0) {
                    this.value = intValue;
                } else {
                    this.value = 0;
                }
            });
        }
        
        // Setup unit history for input field
        function setupUnitHistory(input) {
            if (!input) return;
            
            // Get existing history from localStorage (specific to this field)
            const storageKey = 'unit-history-' + input.id || 'unit-history-default';
            const history = JSON.parse(localStorage.getItem(storageKey) || '[]');
            
            // Update datalist
            const datalist = document.getElementById('unit-history');
            if (datalist) {
                datalist.innerHTML = '';
                history.forEach(unit => {
                    const option = document.createElement('option');
                    option.value = unit;
                    datalist.appendChild(option);
                });
            }
            
            // Save to history when input loses focus
            input.addEventListener('blur', function() {
                const value = this.value.trim();
                if (value && !history.includes(value)) {
                    history.unshift(value);
                    // Keep only last 10 entries
                    if (history.length > 10) {
                        history.pop();
                    }
                    localStorage.setItem(storageKey, JSON.stringify(history));
                    
                    // Update datalist
                    if (datalist) {
                        datalist.innerHTML = '';
                        history.forEach(unit => {
                            const option = document.createElement('option');
                            option.value = unit;
                            datalist.appendChild(option);
                        });
                    }
                }
            });
        }

        // Save request
        async function saveRequest(e) {
            e.preventDefault();
            
            const delivery_address_id = parseInt(document.getElementById('request-delivery-address').value);
            if (!delivery_address_id) {
                alert('è«‹é¸æ“‡é€è²¨åœ°å€');
                return;
            }
            
            // Get applicant name and contact phone from selected address
            const selectedAddress = addressesData.find(addr => addr.id === delivery_address_id);
            if (!selectedAddress) {
                alert('ç„¡æ³•æ‰¾åˆ°é¸æ“‡çš„åœ°å€è³‡è¨Š');
                return;
            }
            
            const applicant_name = selectedAddress.contact_person || document.getElementById('request-applicant-name').value;
            const contact_phone = selectedAddress.contact_phone || document.getElementById('request-contact-phone').value;
            
            if (!applicant_name || !contact_phone) {
                alert('è«‹ç¢ºä¿åœ°å€ä¸­åŒ…å«è¯çµ¡äººå’Œé›»è©±è³‡è¨Š');
                return;
            }
            
            const work_area = document.getElementById('request-work-area').value;
            const construction_category_id = parseInt(document.getElementById('request-construction-category').value);
            const notes = document.getElementById('request-notes').value || null;
            
            const items = [];
            let hasInvalidQuantity = false;
            
            document.querySelectorAll('.request-item').forEach((item, index) => {
                const materialId = item.querySelector('.item-material').value;
                const quantityInput = item.querySelector('.item-quantity');
                const quantity = quantityInput ? parseInt(quantityInput.value, 10) : 0;
                const unit = item.querySelector('.item-unit').value || null;
                const itemNotes = item.querySelector('.item-notes').value || null;
                const imageUrlInput = item.querySelector('.item-image-url');
                const imageUrl = imageUrlInput ? imageUrlInput.value || null : null;
                const linkUrl = item.querySelector('.item-link-url').value || null;
                
                if (materialId) {
                    // Validate quantity: must be non-negative integer
                    if (isNaN(quantity) || quantity < 0) {
                        hasInvalidQuantity = true;
                        return;
                    }
                    items.push({
                        material_id: parseInt(materialId),
                        quantity: Math.max(0, Math.floor(quantity)), // Ensure non-negative integer
                        unit: unit,
                        notes: itemNotes,
                        image_url: imageUrl,
                        link_url: linkUrl
                    });
                }
            });
            
            if (hasInvalidQuantity) {
                alert('æ•¸é‡å¿…é ˆç‚ºéè² æ•´æ•¸ï¼ˆä¸èƒ½ç‚ºè² æ•¸æˆ–å°æ•¸ï¼‰');
                return;
            }
            
            if (items.length === 0) {
                alert('è«‹è‡³å°‘æ·»åŠ ä¸€å€‹ææ–™é …ç›®');
                return;
            }
            
            try {
                console.log('æº–å‚™å»ºç«‹å«æ–™å–®ï¼Œè³‡æ–™ï¼š', {
                    applicant_name,
                    contact_phone,
                    work_area,
                    construction_category_id,
                    delivery_address_id,
                    items_count: items.length,
                    items: items
                });
                
                const response = await fetch('/api/requests', {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        applicant_name,
                        contact_phone,
                        work_area,
                        construction_category_id,
                        delivery_address_id,
                        items,
                        notes
                    })
                });
                
                const responseData = await response.json();
                console.log('ä¼ºæœå™¨å›æ‡‰ï¼š', response.status, responseData);
                
                if (response.ok) {
                    closeModal('request-modal');
                    loadRequests();
                    alert('å«æ–™å–®å»ºç«‹æˆåŠŸï¼');
                } else {
                    const errorMsg = responseData.error || responseData.details || 'æœªçŸ¥éŒ¯èª¤';
                    console.error('å»ºç«‹å¤±æ•—ï¼š', errorMsg, responseData);
                    alert('å»ºç«‹å¤±æ•—ï¼š' + errorMsg + (responseData.details ? '\nè©³æƒ…ï¼š' + responseData.details : ''));
                }
            } catch (error) {
                console.error('å»ºç«‹å«æ–™å–®ç™¼ç”ŸéŒ¯èª¤ï¼š', error);
                alert('å»ºç«‹å¤±æ•—ï¼š' + (error.message || 'ç¶²è·¯éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥é€£ç·š'));
            }
        }
        
        // Load delivery addresses
        // Store addresses data for auto-fill
        let addressesData = [];
        
        async function loadDeliveryAddresses() {
            try {
                const response = await fetch('/api/addresses', {
                    headers: getHeaders()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    addressesData = data.addresses || [];
                    const addressSelect = document.getElementById('request-delivery-address');
                    addressSelect.innerHTML = '<option value="">è«‹é¸æ“‡é€è²¨åœ°å€</option>';
                    
                    addressesData.forEach(addr => {
                        const option = document.createElement('option');
                        option.value = addr.id;
                        option.textContent = `${addr.name}${addr.is_default ? ' (é è¨­)' : ''}`;
                        addressSelect.appendChild(option);
                    });
                    
                    // Set default address if exists and auto-fill
                    const defaultAddr = data.addresses.find(a => a.is_default);
                    if (defaultAddr) {
                        addressSelect.value = defaultAddr.id;
                        autoFillFromAddress(defaultAddr.id);
                    }
                    
                    // Add event listener for address selection change
                    addressSelect.removeEventListener('change', handleAddressChange);
                    addressSelect.addEventListener('change', handleAddressChange);
                    
                    return data.addresses;
                }
            } catch (error) {
                console.error('è¼‰å…¥åœ°å€å¤±æ•—:', error);
            }
            return [];
        }
        
        // Handle address selection change
        function handleAddressChange(event) {
            const addressId = parseInt(event.target.value);
            if (addressId) {
                autoFillFromAddress(addressId);
            } else {
                // Clear fields if no address selected
                document.getElementById('request-applicant-name').value = '';
                document.getElementById('request-contact-phone').value = '';
            }
        }
        
        // Auto-fill applicant name and contact phone from selected address
        function autoFillFromAddress(addressId) {
            const address = addressesData.find(addr => addr.id === addressId);
            if (address) {
                if (address.contact_person) {
                    document.getElementById('request-applicant-name').value = address.contact_person;
                }
                if (address.contact_phone) {
                    document.getElementById('request-contact-phone').value = address.contact_phone;
                }
            }
        }
        
        // Manage addresses
        async function manageAddresses() {
            document.getElementById('address-manage-modal').style.display = 'block';
            await loadAddresses();
        }
        
        // Load addresses for management
        async function loadAddresses() {
            const content = document.getElementById('address-list-content');
            content.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
            
            try {
                const response = await fetch('/api/addresses', {
                    headers: getHeaders()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayAddressList(data.addresses || []);
                } else {
                    content.innerHTML = '<div class="alert alert-error">ç„¡æ³•è¼‰å…¥åœ°å€è³‡æ–™</div>';
                }
            } catch (error) {
                content.innerHTML = '<div class="alert alert-error">è¼‰å…¥å¤±æ•—ï¼š' + error.message + '</div>';
            }
        }
        
        function displayAddressList(addresses) {
            const content = document.getElementById('address-list-content');
            
            if (!content) {
                console.error('ç„¡æ³•æ‰¾åˆ° address-list-content å…ƒç´ ');
                return;
            }
            
            if (addresses.length === 0) {
                content.innerHTML = '<div class="empty-state">å°šç„¡åœ°å€ï¼Œè«‹é»æ“Šã€Œæ–°å¢åœ°å€ã€</div>';
                return;
            }
            
            let tableHtml = '<table><thead><tr><th>åç¨±</th><th>åœ°å€</th><th>è¯çµ¡äºº</th><th>è¯çµ¡é›»è©±</th><th>é è¨­</th><th>æ“ä½œ</th></tr></thead><tbody>';
            let cardHtml = '<div class="mobile-card">';
            
            addresses.forEach(addr => {
                const defaultBadge = addr.is_default ? ' <span style="color: #667eea;">(é è¨­)</span>' : '';
                
                // Desktop table row
                tableHtml += `
                    <tr>
                        <td>${escapeHtml(addr.name)}${defaultBadge}</td>
                        <td>${escapeHtml(addr.address || '-')}</td>
                        <td>${escapeHtml(addr.contact_person || '-')}</td>
                        <td>${escapeHtml(addr.contact_phone || '-')}</td>
                        <td>${addr.is_default ? 'æ˜¯' : 'å¦'}</td>
                        <td>
                            <button class="btn-secondary btn-small" onclick="editAddressById(${addr.id})" style="margin-right: 5px;">ç·¨è¼¯</button>
                            <button class="btn-danger btn-small" onclick="deleteAddress(${addr.id})">åˆªé™¤</button>
                        </td>
                    </tr>
                `;
                
                // Mobile card
                cardHtml += `
                    <div class="mobile-card-item">
                        <div class="mobile-card-item-header">${escapeHtml(addr.name)}${defaultBadge}</div>
                        <div class="mobile-card-item-row">
                            <span class="mobile-card-item-label">åœ°å€</span>
                            <span class="mobile-card-item-value">${escapeHtml(addr.address || '-')}</span>
                        </div>
                        <div class="mobile-card-item-row">
                            <span class="mobile-card-item-label">è¯çµ¡äºº</span>
                            <span class="mobile-card-item-value">${escapeHtml(addr.contact_person || '-')}</span>
                        </div>
                        <div class="mobile-card-item-row">
                            <span class="mobile-card-item-label">è¯çµ¡é›»è©±</span>
                            <span class="mobile-card-item-value">${escapeHtml(addr.contact_phone || '-')}</span>
                        </div>
                        <div class="mobile-card-item-row">
                            <span class="mobile-card-item-label">é è¨­</span>
                            <span class="mobile-card-item-value">${addr.is_default ? 'æ˜¯' : 'å¦'}</span>
                        </div>
                        <div class="mobile-card-item-actions">
                            <button class="btn-secondary btn-small" onclick="editAddressById(${addr.id})">ç·¨è¼¯</button>
                            <button class="btn-danger btn-small" onclick="deleteAddress(${addr.id})">åˆªé™¤</button>
                        </div>
                    </div>
                `;
            });
            
            tableHtml += '</tbody></table>';
            cardHtml += '</div>';
            content.innerHTML = tableHtml + cardHtml;
        }
        
        // Show add address form
        function showAddAddressForm() {
            document.getElementById('address-modal-title').textContent = 'æ–°å¢åœ°å€';
            document.getElementById('address-form').reset();
            document.getElementById('address-id').value = '';
            document.getElementById('address-is-default').checked = false;
            document.getElementById('address-modal').style.display = 'block';
        }
        
        // Edit address
        async function editAddressById(id) {
            try {
                const response = await fetch('/api/addresses', {
                    headers: getHeaders()
                });
                
                if (!response.ok) {
                    alert('ç„¡æ³•è¼‰å…¥åœ°å€è³‡æ–™');
                    return;
                }
                
                const data = await response.json();
                const addr = data.addresses.find(a => a.id == id);
                
                if (!addr) {
                    alert('æ‰¾ä¸åˆ°åœ°å€è³‡æ–™');
                    return;
                }
                
                document.getElementById('address-modal-title').textContent = 'ç·¨è¼¯åœ°å€';
                document.getElementById('address-id').value = addr.id;
                document.getElementById('address-name').value = addr.name;
                document.getElementById('address-address').value = addr.address || '';
                document.getElementById('address-contact-person').value = addr.contact_person || '';
                document.getElementById('address-contact-phone').value = addr.contact_phone || '';
                document.getElementById('address-is-default').checked = addr.is_default || false;
                
                document.getElementById('address-modal').style.display = 'block';
            } catch (error) {
                alert('è¼‰å…¥åœ°å€è³‡æ–™å¤±æ•—ï¼š' + error.message);
            }
        }
        
        // Delete address
        async function deleteAddress(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤åœ°å€å—ï¼Ÿå¦‚æœæ­¤åœ°å€å·²è¢«ä½¿ç”¨ï¼Œå°‡ç„¡æ³•åˆªé™¤ã€‚')) return;
            
            try {
                const response = await fetch(`/api/addresses/${id}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });
                
                if (response.ok) {
                    await loadAddresses();
                    await loadDeliveryAddresses(); // Refresh dropdown
                } else {
                    const error = await response.json();
                    alert('åˆªé™¤å¤±æ•—ï¼š' + (error.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                alert('åˆªé™¤å¤±æ•—ï¼š' + error.message);
            }
        }
        
        // Save address
        async function saveAddress(e) {
            e.preventDefault();
            
            const id = document.getElementById('address-id').value;
            const name = document.getElementById('address-name').value;
            const address = document.getElementById('address-address').value;
            const contact_person = document.getElementById('address-contact-person').value || null;
            const contact_phone = document.getElementById('address-contact-phone').value || null;
            const is_default = document.getElementById('address-is-default').checked;
            
            let endpoint = '/api/addresses';
            let method = 'POST';
            
            if (id) {
                endpoint += `/${id}`;
                method = 'PUT';
            }
            
            try {
                const response = await fetch(endpoint, {
                    method: method,
                    headers: getHeaders(),
                    body: JSON.stringify({ name, address, contact_person, contact_phone, is_default })
                });
                
                if (response.ok) {
                    closeModal('address-modal');
                    await loadAddresses();
                    await loadDeliveryAddresses(); // Refresh dropdown
                    alert(id ? 'åœ°å€æ›´æ–°æˆåŠŸï¼' : 'åœ°å€å»ºç«‹æˆåŠŸï¼');
                } else {
                    const error = await response.json();
                    alert('å„²å­˜å¤±æ•—ï¼š' + (error.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                alert('å„²å­˜å¤±æ•—ï¼š' + error.message);
            }
        }

        // Company management functions
        function getCompanies() {
            const companiesJson = localStorage.getItem('companies');
            return companiesJson ? JSON.parse(companiesJson) : [];
        }

        function saveCompanies(companies) {
            localStorage.setItem('companies', JSON.stringify(companies));
        }

        function getDefaultCompany() {
            const companies = getCompanies();
            return companies.find(c => c.is_default) || companies[0] || null;
        }

        // Load companies from environment variables
        async function loadDefaultCompanyFromEnv() {
            try {
                console.log('é–‹å§‹è¼‰å…¥ç’°å¢ƒè®Šæ•¸å…¬å¸è³‡è¨Š...');
                const response = await fetch('/api/requests/default-company', {
                    headers: getHeaders()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const envCompanies = data.companies || [];
                    console.log('ç’°å¢ƒè®Šæ•¸å…¬å¸æ•¸é‡:', envCompanies.length, envCompanies);
                    
                    if (envCompanies.length > 0) {
                        const companies = getCompanies();
                        const envCompanyIds = envCompanies.map((_, index) => `env_company_${index}`);
                        
                        // Remove old env companies that are no longer in env
                        const filteredCompanies = companies.filter(c => !c.from_env || envCompanyIds.includes(c.id));
                        
                        // Add or update env companies
                        envCompanies.forEach((envCompany, index) => {
                            const envCompanyId = `env_company_${index}`;
                            const existingIndex = filteredCompanies.findIndex(c => c.id === envCompanyId);
                            
                            if (existingIndex === -1) {
                                // Add new env company
                                filteredCompanies.unshift({
                                    id: envCompanyId,
                                    name: envCompany.name,
                                    tax_id: envCompany.tax_id,
                                    is_default: index === 0, // First one is default
                                    from_env: true
                                });
                                console.log('æ–°å¢ç’°å¢ƒè®Šæ•¸å…¬å¸:', envCompany.name);
                            } else {
                                // Update existing env company
                                filteredCompanies[existingIndex].name = envCompany.name;
                                filteredCompanies[existingIndex].tax_id = envCompany.tax_id;
                                filteredCompanies[existingIndex].from_env = true;
                                console.log('æ›´æ–°ç’°å¢ƒè®Šæ•¸å…¬å¸:', envCompany.name);
                            }
                        });
                        
                        // Set first env company as default if no default exists
                        const hasDefault = filteredCompanies.some(c => c.is_default);
                        if (!hasDefault && filteredCompanies.length > 0) {
                            const firstEnvCompany = filteredCompanies.find(c => c.from_env);
                            if (firstEnvCompany) {
                                filteredCompanies.forEach(c => c.is_default = false);
                                firstEnvCompany.is_default = true;
                                console.log('è¨­å®šé è¨­å…¬å¸:', firstEnvCompany.name);
                            }
                        }
                        
                        saveCompanies(filteredCompanies);
                        console.log('ç’°å¢ƒè®Šæ•¸å…¬å¸è¼‰å…¥å®Œæˆï¼Œå…±', filteredCompanies.filter(c => c.from_env).length, 'å®¶å…¬å¸');
                    } else {
                        console.log('ç’°å¢ƒè®Šæ•¸ä¸­æ²’æœ‰å…¬å¸è³‡è¨Š');
                    }
                } else {
                    const errorText = await response.text();
                    console.error('è¼‰å…¥ç’°å¢ƒè®Šæ•¸å…¬å¸å¤±æ•—:', response.status, errorText);
                }
            } catch (error) {
                console.error('è¼‰å…¥ç’°å¢ƒè®Šæ•¸å…¬å¸è³‡è¨Šå¤±æ•—:', error);
            }
        }

        async function manageCompanies() {
            document.getElementById('company-manage-modal').style.display = 'block';
            await loadCompanies();
        }

        async function loadCompanies() {
            // First, try to load default company from environment variables
            await loadDefaultCompanyFromEnv();
            
            const companies = getCompanies();
            const content = document.getElementById('company-list-content');
            
            if (companies.length === 0) {
                content.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">å°šç„¡å…¬å¸è³‡æ–™ï¼Œè«‹é»æ“Šã€Œæ–°å¢å…¬å¸ã€æŒ‰éˆ•æ–°å¢</div>';
                return;
            }

            let html = '<table><thead><tr><th>å…¬å¸åç¨±</th><th>çµ±ç·¨</th><th>ä¾†æº</th><th>é è¨­</th><th>æ“ä½œ</th></tr></thead><tbody>';
            companies.forEach(company => {
                const source = company.from_env ? '<span style="color: #667eea;">ç’°å¢ƒè®Šæ•¸</span>' : 'æ‰‹å‹•æ–°å¢';
                const canDelete = !company.from_env;
                html += `
                    <tr>
                        <td>${escapeHtml(company.name)}</td>
                        <td>${escapeHtml(company.tax_id)}</td>
                        <td>${source}</td>
                        <td>${company.is_default ? 'âœ“' : ''}</td>
                        <td>
                            ${canDelete ? `<button class="btn-secondary" onclick="editCompanyById('${company.id}')" style="margin-right: 5px;">ç·¨è¼¯</button>` : '<span style="color: #999;">ä¸å¯ç·¨è¼¯</span>'}
                            ${canDelete ? `<button class="btn-danger" onclick="deleteCompany('${company.id}')">åˆªé™¤</button>` : ''}
                        </td>
                    </tr>
                `;
            });
            html += '</tbody></table>';

            // Mobile card view
            html += '<div class="mobile-card">';
            companies.forEach(company => {
                const source = company.from_env ? '<span style="color: #667eea;">ç’°å¢ƒè®Šæ•¸</span>' : 'æ‰‹å‹•æ–°å¢';
                const canDelete = !company.from_env;
                html += `
                    <div class="mobile-card-item">
                        <div class="mobile-card-item-header">${escapeHtml(company.name)}</div>
                        <div class="mobile-card-item-row">
                            <span class="mobile-card-item-label">çµ±ç·¨</span>
                            <span class="mobile-card-item-value">${escapeHtml(company.tax_id)}</span>
                        </div>
                        <div class="mobile-card-item-row">
                            <span class="mobile-card-item-label">ä¾†æº</span>
                            <span class="mobile-card-item-value">${source}</span>
                        </div>
                        ${company.is_default ? '<div class="mobile-card-item-row"><span class="mobile-card-item-label">é è¨­</span><span class="mobile-card-item-value">âœ“</span></div>' : ''}
                        <div class="mobile-card-item-actions">
                            ${canDelete ? `<button class="btn-secondary" onclick="editCompanyById('${company.id}')">ç·¨è¼¯</button>` : ''}
                            ${canDelete ? `<button class="btn-danger" onclick="deleteCompany('${company.id}')">åˆªé™¤</button>` : '<span style="color: #999; font-size: 0.9em;">ç’°å¢ƒè®Šæ•¸å…¬å¸ä¸å¯ç·¨è¼¯</span>'}
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            content.innerHTML = html;
        }

        function showAddCompanyForm() {
            document.getElementById('company-modal-title').textContent = 'æ–°å¢å…¬å¸';
            document.getElementById('company-form').reset();
            document.getElementById('company-id').value = '';
            document.getElementById('company-is-default').checked = false;
            document.getElementById('company-modal').style.display = 'block';
        }

        function editCompanyById(id) {
            const companies = getCompanies();
            const company = companies.find(c => c.id === id);
            if (!company) {
                alert('æ‰¾ä¸åˆ°å…¬å¸è³‡æ–™');
                return;
            }

            if (company.from_env) {
                alert('ç„¡æ³•ç·¨è¼¯ç’°å¢ƒè®Šæ•¸è¨­å®šçš„å…¬å¸');
                return;
            }

            document.getElementById('company-modal-title').textContent = 'ç·¨è¼¯å…¬å¸';
            document.getElementById('company-id').value = company.id;
            document.getElementById('company-name').value = company.name;
            document.getElementById('company-tax-id').value = company.tax_id;
            document.getElementById('company-is-default').checked = company.is_default || false;
            document.getElementById('company-modal').style.display = 'block';
        }

        function saveCompany(event) {
            event.preventDefault();
            const id = document.getElementById('company-id').value;
            const name = document.getElementById('company-name').value.trim();
            const taxId = document.getElementById('company-tax-id').value.trim();
            const isDefault = document.getElementById('company-is-default').checked;

            if (!name || !taxId) {
                alert('è«‹å¡«å¯«å®Œæ•´è³‡æ–™');
                return;
            }

            const companies = getCompanies();
            
            if (isDefault) {
                // Remove default flag from other companies
                companies.forEach(c => c.is_default = false);
            }

            if (id) {
                // Update existing
                const index = companies.findIndex(c => c.id === id);
                if (index !== -1) {
                    companies[index] = { id, name, tax_id: taxId, is_default: isDefault };
                }
            } else {
                // Add new
                const newId = 'company_' + Date.now();
                companies.push({ id: newId, name, tax_id: taxId, is_default: isDefault });
            }

            saveCompanies(companies);
            closeModal('company-modal');
            loadCompanies();
            alert(id ? 'å…¬å¸æ›´æ–°æˆåŠŸï¼' : 'å…¬å¸å»ºç«‹æˆåŠŸï¼');
        }

        function deleteCompany(id) {
            const companies = getCompanies();
            const company = companies.find(c => c.id === id);
            
            if (company && company.from_env) {
                alert('ç„¡æ³•åˆªé™¤ç’°å¢ƒè®Šæ•¸è¨­å®šçš„å…¬å¸');
                return;
            }
            
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å…¬å¸å—ï¼Ÿ')) return;
            
            const filtered = companies.filter(c => c.id !== id);
            saveCompanies(filtered);
            loadCompanies();
            alert('å…¬å¸å·²åˆªé™¤');
        }

        // Company selection for Excel/Email
        let companySelectionCallback = null;

        async function selectCompany(callback) {
            // Ensure env companies are loaded before showing selection
            await loadDefaultCompanyFromEnv();
            
            companySelectionCallback = callback;
            const companies = getCompanies();
            const dropdown = document.getElementById('company-select-dropdown');
            
            dropdown.innerHTML = '<option value="">-- è«‹é¸æ“‡å…¬å¸ --</option>';
            companies.forEach(company => {
                const option = document.createElement('option');
                option.value = company.id;
                const envLabel = company.from_env ? ' [ç’°å¢ƒè®Šæ•¸]' : '';
                option.textContent = `${company.name} (${company.tax_id})${company.is_default ? ' [é è¨­]' : ''}${envLabel}`;
                dropdown.appendChild(option);
            });

            // Set default company if exists
            const defaultCompany = getDefaultCompany();
            if (defaultCompany) {
                dropdown.value = defaultCompany.id;
            }

            document.getElementById('company-select-name').value = '';
            document.getElementById('company-select-tax-id').value = '';
            document.getElementById('company-select-modal').style.display = 'block';
        }

        function confirmCompanySelection() {
            const dropdown = document.getElementById('company-select-dropdown');
            const nameInput = document.getElementById('company-select-name');
            const taxIdInput = document.getElementById('company-select-tax-id');

            let companyName = '';
            let taxId = '';

            if (dropdown.value) {
                // Selected from dropdown
                const companies = getCompanies();
                const selected = companies.find(c => c.id === dropdown.value);
                if (selected) {
                    companyName = selected.name;
                    taxId = selected.tax_id;
                }
            } else {
                // Manual input
                companyName = nameInput.value.trim();
                taxId = taxIdInput.value.trim();
            }

            if (!companyName && !taxId) {
                // Use empty values (will use default from env)
                companyName = '';
                taxId = '';
            }

            closeModal('company-select-modal');
            
            if (companySelectionCallback) {
                companySelectionCallback(companyName, taxId);
                companySelectionCallback = null;
            }
        }

        // Send email for request
        async function sendRequestEmail(id) {
            if (!confirm('ç¢ºå®šè¦ç™¼é€éƒµä»¶å—ï¼Ÿ')) return;
            
            await selectCompany(async (companyName, taxId) => {
                try {
                    const params = new URLSearchParams();
                    if (companyName) params.append('company_name', companyName);
                    if (taxId) params.append('tax_id', taxId);
                    
                    const url = `/api/requests/${id}/send-email${params.toString() ? '?' + params.toString() : ''}`;
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: getHeaders()
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        alert(`âœ… ${data.message}\næ”¶ä»¶äººï¼š${data.recipients.join(', ')}`);
                    } else {
                        const error = await response.json();
                        alert('ç™¼é€å¤±æ•—ï¼š' + (error.error || 'æœªçŸ¥éŒ¯èª¤'));
                    }
                } catch (error) {
                    alert('ç™¼é€å¤±æ•—ï¼š' + error.message);
                }
            });
        }

        // Delete request
        async function deleteRequest(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å«æ–™å–®å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;
            
            try {
                const response = await fetch(`/api/requests/${id}`, {
                    method: 'DELETE',
                    headers: getHeaders()
                });
                
                if (response.ok) {
                    loadRequests();
                    alert('å«æ–™å–®å·²åˆªé™¤');
                } else {
                    const error = await response.json();
                    alert('åˆªé™¤å¤±æ•—ï¼š' + (error.error || 'æœªçŸ¥éŒ¯èª¤'));
                }
            } catch (error) {
                alert('åˆªé™¤å¤±æ•—ï¼š' + error.message);
            }
        }
        
        // Download Excel for request
        async function downloadRequestExcel(id) {
            await selectCompany(async (companyName, taxId) => {
                try {
                    const params = new URLSearchParams();
                    if (companyName) params.append('company_name', companyName);
                    if (taxId) params.append('tax_id', taxId);
                    
                    const url = `/api/requests/${id}/excel${params.toString() ? '?' + params.toString() : ''}`;
                    const response = await fetch(url, {
                        headers: getHeaders()
                    });
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        const downloadUrl = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = downloadUrl;
                        
                        // Get filename from Content-Disposition header
                        const contentDisposition = response.headers.get('Content-Disposition');
                        let filename = `å«æ–™å–®_${id}.xlsx`;
                        if (contentDisposition) {
                            // Try RFC 5987 format first (filename*=UTF-8'')
                            const rfc5987Match = contentDisposition.match(/filename\*=UTF-8''([^;]+)/);
                            if (rfc5987Match) {
                                filename = decodeURIComponent(rfc5987Match[1]);
                            } else {
                                // Fallback to standard format
                                const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                                if (filenameMatch && filenameMatch[1]) {
                                    const extracted = filenameMatch[1].replace(/['"]/g, '');
                                    // Try to decode if it's URL encoded
                                    try {
                                        filename = decodeURIComponent(extracted);
                                    } catch (e) {
                                        filename = extracted;
                                    }
                                }
                            }
                        }
                        
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(downloadUrl);
                        alert('âœ… Excel æª”æ¡ˆä¸‹è¼‰æˆåŠŸï¼');
                    } else {
                        const errorText = await response.text();
                        let errorMessage = 'ä¸‹è¼‰å¤±æ•—';
                        try {
                            const errorJson = JSON.parse(errorText);
                            errorMessage = errorJson.error || errorMessage;
                        } catch (e) {
                            errorMessage = errorText || errorMessage;
                        }
                        console.error('ä¸‹è¼‰å¤±æ•—:', response.status, errorMessage);
                        alert('ä¸‹è¼‰å¤±æ•—ï¼š' + errorMessage + ' (ç‹€æ…‹ç¢¼: ' + response.status + ')');
                    }
                } catch (error) {
                    alert('ä¸‹è¼‰å¤±æ•—ï¼š' + error.message);
                }
            });
        }

        // View request detail
        async function viewRequest(id) {
            const content = document.getElementById('request-detail-content');
            content.innerHTML = '<div class="loading">è¼‰å…¥ä¸­...</div>';
            document.getElementById('request-detail-modal').style.display = 'block';
            
            try {
                const response = await fetch(`/api/requests/${id}`, {
                    headers: getHeaders()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayRequestDetail(data.request, data.items || []);
                } else {
                    content.innerHTML = '<div class="alert alert-error">ç„¡æ³•è¼‰å…¥å«æ–™å–®è©³æƒ…</div>';
                }
            } catch (error) {
                content.innerHTML = '<div class="alert alert-error">è¼‰å…¥å¤±æ•—ï¼š' + error.message + '</div>';
            }
        }

        function displayRequestDetail(request, items) {
            const content = document.getElementById('request-detail-content');
            
            let html = `
                <div class="form-group">
                    <label>å–®è™Ÿ</label>
                    <p>${request.request_number}</p>
                </div>
                <div class="form-group">
                    <label>ç”³è«‹äºº</label>
                    <p>${request.applicant_name || '-'}</p>
                </div>
                <div class="form-group">
                    <label>è¯ç¹«é›»è©±</label>
                    <p>${request.contact_phone || '-'}</p>
                </div>
                <div class="form-group">
                    <label>å·¥å€</label>
                    <p>${request.work_area || '-'}</p>
                </div>
                <div class="form-group">
                    <label>æ–½å·¥é¡åˆ¥</label>
                    <p>${request.construction_category_name || '-'}</p>
                </div>
                <div class="form-group">
                    <label>é€è²¨åœ°å€</label>
                    <p>${request.delivery_address_name || '-'}${request.delivery_address ? '<br>' + request.delivery_address : ''}</p>
                </div>
                <div class="form-group">
                    <label>ç‹€æ…‹</label>
                    <p>${request.status || 'pending'}</p>
                </div>
                <div class="form-group">
                    <label>å‚™è¨»</label>
                    <p>${request.notes || '-'}</p>
                </div>
                <div class="form-group">
                    <label>å»ºç«‹æ™‚é–“</label>
                    <p>${formatDateTimeToMinute(request.created_at)}</p>
                </div>
                <div class="form-group">
                    <label>ææ–™é …ç›®</label>
                    <table>
                        <thead>
                            <tr>
                                <th>ææ–™åç¨±</th>
                                <th>æ•¸é‡</th>
                                <th>å–®ä½</th>
                                <th>å‚™è¨»</th>
                                <th>åœ–ç‰‡</th>
                                <th>é€£çµ</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            items.forEach(item => {
                const imageDisplay = item.image_url ? 
                    `<a href="${item.image_url}" target="_blank" style="color: #667eea; text-decoration: none; display: inline-flex; align-items: center; gap: 4px;">
                        <span>ğŸ–¼ï¸</span> æŸ¥çœ‹åœ–ç‰‡
                    </a>` : '-';
                const linkDisplay = item.link_url ? 
                    `<a href="${item.link_url}" target="_blank" style="color: #667eea; text-decoration: none; display: inline-flex; align-items: center; gap: 4px;">
                        <span>ğŸ”—</span> é–‹å•Ÿé€£çµ
                    </a>` : '-';
                html += `
                    <tr>
                        <td>${item.material_name || '-'}</td>
                        <td>${Math.floor(item.quantity || 0)}</td>
                        <td>${item.unit || item.material_unit || '-'}</td>
                        <td>${item.notes || '-'}</td>
                        <td>${imageDisplay}</td>
                        <td>${linkDisplay}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 20px; text-align: center; padding-top: 20px; border-top: 1px solid #ddd;">
                    <button class="btn-primary" onclick="sendRequestEmail(${request.id})" style="margin-right: 10px;">ğŸ“§ ç™¼é€éƒµä»¶</button>
                    <button class="btn-primary" onclick="downloadRequestExcel(${request.id})">ğŸ“¥ ä¸‹è¼‰Excel</button>
                </div>
            `;
            
            content.innerHTML = html;
        }

        // Load reports
        async function loadReports() {
            const content = document.getElementById('reports-content');
            
            try {
                const requestsRes = await fetch('/api/requests', {
                    headers: getHeaders()
                });
                
                if (requestsRes.ok) {
                    const data = await requestsRes.json();
                    const requests = data.requests || [];
                    
                    const total = requests.length;
                    const pending = requests.filter(r => r.status === 'pending').length;
                    const completed = requests.filter(r => r.status === 'completed').length;
                    
                    // Format numbers with thousand separators
                    function formatNumber(num) {
                        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                    }
                    
                    const now = new Date();
                    const currentYear = now.getFullYear();
                    const currentMonth = now.getMonth() + 1;
                    
                    content.innerHTML = `
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3>ç¸½å«æ–™å–®æ•¸</h3>
                                <p class="stat-number">${formatNumber(total)}</p>
                            </div>
                            <div class="stat-card">
                                <h3>å¾…è™•ç†</h3>
                                <p class="stat-number">${formatNumber(pending)}</p>
                            </div>
                            <div class="stat-card">
                                <h3>å·²å®Œæˆ</h3>
                                <p class="stat-number">${formatNumber(completed)}</p>
                            </div>
                        </div>
                        <div style="margin-top: 30px;">
                            <h3 style="margin-bottom: 20px; font-size: 1.25rem; font-weight: 700; color: #111827;">å ±è¡¨ä¸‹è¼‰</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
                                <div style="padding: 24px; border: 1px solid #e5e7eb; border-radius: 12px; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                    <h4 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 16px; color: #111827;">æœˆå ±è¡¨</h4>
                                    <div style="margin-top: 15px;">
                                        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #374151; font-size: 0.875rem;">å¹´ä»½</label>
                                        <input type="number" id="report-year" value="${currentYear}" style="width: 100%; padding: 10px 12px; margin-bottom: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.9375rem;">
                                        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #374151; font-size: 0.875rem;">æœˆä»½</label>
                                        <input type="number" id="report-month" value="${currentMonth}" min="1" max="12" style="width: 100%; padding: 10px 12px; margin-bottom: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.9375rem;">
                                        <button class="btn-primary" onclick="downloadMonthlyReport()" style="width: 100%; padding: 12px; font-size: 0.9375rem; border-radius: 8px;">ä¸‹è¼‰æœˆå ±è¡¨</button>
                                    </div>
                                </div>
                                <div style="padding: 24px; border: 1px solid #e5e7eb; border-radius: 12px; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                    <h4 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 16px; color: #111827;">æ™‚é–“å€é–“å ±è¡¨</h4>
                                    <div style="margin-top: 15px;">
                                        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #374151; font-size: 0.875rem;">é–‹å§‹æ—¥æœŸ</label>
                                        <input type="date" id="report-start-date" style="width: 100%; padding: 10px 12px; margin-bottom: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.9375rem;">
                                        <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #374151; font-size: 0.875rem;">çµæŸæ—¥æœŸ</label>
                                        <input type="date" id="report-end-date" style="width: 100%; padding: 10px 12px; margin-bottom: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.9375rem;">
                                        <button class="btn-primary" onclick="downloadRangeReport()" style="width: 100%; padding: 12px; font-size: 0.9375rem; border-radius: 8px;">ä¸‹è¼‰å€é–“å ±è¡¨</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    content.innerHTML = '<div class="alert alert-error">ç„¡æ³•è¼‰å…¥å ±è¡¨è³‡æ–™</div>';
                }
            } catch (error) {
                content.innerHTML = '<div class="alert alert-error">è¼‰å…¥å¤±æ•—ï¼š' + error.message + '</div>';
            }
        }

        // Download monthly report
        async function downloadMonthlyReport() {
            const year = document.getElementById('report-year').value;
            const month = document.getElementById('report-month').value;
            
            if (!year || !month) {
                alert('è«‹è¼¸å…¥å¹´ä»½å’Œæœˆä»½');
                return;
            }
            
            await selectCompany(async (companyName, taxId) => {
                try {
                    const params = new URLSearchParams();
                    if (companyName) params.append('company_name', companyName);
                    if (taxId) params.append('tax_id', taxId);
                    
                    const url = `/api/requests/reports/monthly/${year}/${month}${params.toString() ? '?' + params.toString() : ''}`;
                    const response = await fetch(url, {
                        headers: getHeaders()
                    });
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        const downloadUrl = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = downloadUrl;
                        a.download = `å«æ–™å–®æœˆå ±è¡¨_${year}å¹´${month}æœˆ.xlsx`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(downloadUrl);
                    } else {
                        const error = await response.json();
                        alert('ä¸‹è¼‰å¤±æ•—ï¼š' + (error.error || 'æœªçŸ¥éŒ¯èª¤'));
                    }
                } catch (error) {
                    alert('ä¸‹è¼‰å¤±æ•—ï¼š' + error.message);
                }
            });
        }

        // Download date range report
        async function downloadRangeReport() {
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            
            if (!startDate || !endDate) {
                alert('è«‹é¸æ“‡é–‹å§‹æ—¥æœŸå’ŒçµæŸæ—¥æœŸ');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸ');
                return;
            }
            
            await selectCompany(async (companyName, taxId) => {
                try {
                    const params = new URLSearchParams();
                    params.append('start_date', startDate);
                    params.append('end_date', endDate);
                    if (companyName) params.append('company_name', companyName);
                    if (taxId) params.append('tax_id', taxId);
                    
                    const url = `/api/requests/reports/range?${params.toString()}`;
                    const response = await fetch(url, {
                        headers: getHeaders()
                    });
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        const downloadUrl = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = downloadUrl;
                        a.download = `å«æ–™å–®å ±è¡¨_${startDate}_${endDate}.xlsx`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(downloadUrl);
                    } else {
                        const error = await response.json();
                        alert('ä¸‹è¼‰å¤±æ•—ï¼š' + (error.error || 'æœªçŸ¥éŒ¯èª¤'));
                    }
                } catch (error) {
                    alert('ä¸‹è¼‰å¤±æ•—ï¼š' + error.message);
                }
            });
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Setup material filter event listeners
        function setupMaterialFilters() {
            const searchInput = document.getElementById('material-search');
            const constructionFilter = document.getElementById('filter-construction-category');
            const materialFilter = document.getElementById('filter-material-category');
            
            if (searchInput) {
                // Debounce search input
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        filterMaterials();
                    }, 300);
                });
            }
            
            if (constructionFilter) {
                constructionFilter.addEventListener('change', filterMaterials);
            }
            
            if (materialFilter) {
                materialFilter.addEventListener('change', filterMaterials);
            }
        }
        
        // Initialize on page load
        

        // Debug: Log all click events
        document.addEventListener('click', function(e) {
            console.log('Click detected:', e.target, e.target.onclick, e.target.className);
        }, true);

        // Ensure all onclick handlers are available globally
        window.showHome = showHome;
        window.navigateToSection = navigateToSection;
        window.openSection = function(section) {
            if (typeof navigateToSection === 'function') {
                navigateToSection(section);
            } else {
                console.error('navigateToSection function not found');
            }
        };


        // Expose all functions to global scope for onclick handlers
        window.showCreateRequestForm = showCreateRequestForm;
        window.downloadRequestExcel = downloadRequestExcel;
        window.sendRequestEmail = sendRequestEmail;
        window.deleteRequest = deleteRequest;
        window.viewRequest = viewRequest;
        window.showAddMaterialForm = showAddMaterialForm;
        window.editMaterialById = editMaterialById;
        window.deleteMaterial = deleteMaterial;
        window.quickAddSpecification = quickAddSpecification;
        window.manageCategories = manageCategories;
        window.manageAddresses = manageAddresses;
        window.manageCompanies = manageCompanies;
        window.showAddCategoryForm = showAddCategoryForm;
        window.editCategoryById = editCategoryById;
        window.deleteCategory = deleteCategory;
        window.showAddAddressForm = showAddAddressForm;
        window.editAddressById = editAddressById;
        window.deleteAddress = deleteAddress;
        window.showAddCompanyForm = showAddCompanyForm;
        window.editCompanyById = editCompanyById;
        window.deleteCompany = deleteCompany;
        window.confirmCompanySelection = confirmCompanySelection;
        window.closeModal = closeModal;
        window.removeRequestItem = removeRequestItem;
        window.addRequestItem = addRequestItem;
        window.removeImage = removeImage;
        window.downloadMonthlyReport = downloadMonthlyReport;
        window.downloadRangeReport = downloadRangeReport;
        window.clearMaterialFilters = clearMaterialFilters;
        window.showHome = showHome;
        window.openSection = openSection;
        window.navigateToSection = navigateToSection;

        function initializeApp() {
            (async function() {
                try {
                    await init();
                    const userNameEl = document.getElementById('userName');
                    const welcomeMessageEl = document.getElementById('welcomeMessage');
                    if (userNameEl) userNameEl.textContent = 'ä½¿ç”¨è€…';
                    if (welcomeMessageEl) welcomeMessageEl.textContent = 'å«æ–™ç³»çµ±';
                    
                    // Load default company from environment variables
                    if (typeof loadDefaultCompanyFromEnv === 'function') {
                        await loadDefaultCompanyFromEnv();
                    }
                    
                    // Setup material filter event listeners
                    if (typeof setupMaterialFilters === 'function') {
                        setupMaterialFilters();
                    }
                    
                    // Handle browser back/forward buttons
                    if (typeof handlePopState === 'function') {
                        window.addEventListener('popstate', handlePopState);
                    }
                    
                    // Check URL hash on load
                    if (typeof getSectionFromHash === 'function') {
                        const section = getSectionFromHash();
                        if (section && typeof navigateToSection === 'function') {
                            navigateToSection(section);
                        } else {
                            if (window.history && window.history.replaceState) {
                                history.replaceState({ section: null }, '', window.location.pathname);
                            }
                        }
                    }
                } catch (error) {
                    console.error('æ‡‰ç”¨åˆå§‹åŒ–éŒ¯èª¤:', error);
                }
            })();
        }
        
        // Use DOMContentLoaded with fallback for Safari
        if (document.addEventListener) {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeApp);
            } else {
                // DOM already loaded
                initializeApp();
            }
        } else if (document.attachEvent) {
            // IE8 fallback
            document.attachEvent('onreadystatechange', function() {
                if (document.readyState === 'complete') {
                    initializeApp();
                }
            });
        } else {
            // Fallback for very old browsers
            window.onload = initializeApp;
        }
    
        } catch (error) {
            console.error('JavaScriptåŸ·è¡ŒéŒ¯èª¤:', error);
            alert('é é¢è¼‰å…¥ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢ã€‚éŒ¯èª¤: ' + error.message);
        }
</script>
    
    <!-- Bottom Navigation Bar for Mobile -->
    <nav class="bottom-nav" id="bottom-nav">
        <a href="#" class="bottom-nav-item" id="nav-home" onclick="event.preventDefault(); showHome(); updateBottomNav('home');">
            <div class="bottom-nav-item-icon">ğŸ </div>
            <div class="bottom-nav-item-text">é¦–é </div>
        </a>
        <a href="#" class="bottom-nav-item" id="nav-requests" onclick="event.preventDefault(); openSection('requests'); updateBottomNav('requests');">
            <div class="bottom-nav-item-icon">ğŸ“‹</div>
            <div class="bottom-nav-item-text">å«æ–™å–®</div>
        </a>
        <a href="#" class="bottom-nav-item" id="nav-materials" onclick="event.preventDefault(); openSection('materials'); updateBottomNav('materials');">
            <div class="bottom-nav-item-icon">ğŸ“¦</div>
            <div class="bottom-nav-item-text">ç‰©æ–™</div>
        </a>
        <a href="#" class="bottom-nav-item" id="nav-reports" onclick="event.preventDefault(); openSection('reports'); updateBottomNav('reports');">
            <div class="bottom-nav-item-icon">ğŸ“Š</div>
            <div class="bottom-nav-item-text">å ±è¡¨</div>
        </a>
    </nav>
    
    <script>
        // Update bottom navigation active state
        function updateBottomNav(activeSection) {
            const navItems = document.querySelectorAll('.bottom-nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            
            const navMap = {
                'home': 'nav-home',
                'requests': 'nav-requests',
                'materials': 'nav-materials',
                'reports': 'nav-reports'
            };
            
            const activeNavId = navMap[activeSection];
            if (activeNavId) {
                const activeNav = document.getElementById(activeNavId);
                if (activeNav) {
                    activeNav.classList.add('active');
                }
            }
        }
        
        // Show/hide bottom nav based on screen size
        function toggleBottomNav() {
            const bottomNav = document.getElementById('bottom-nav');
            if (!bottomNav) return;
            
            if (window.innerWidth <= 768) {
                bottomNav.style.display = 'flex';
                if (!document.body.style.paddingBottom || document.body.style.paddingBottom === '0px') {
                    document.body.style.paddingBottom = '70px';
                }
            } else {
                bottomNav.style.display = 'none';
                document.body.style.paddingBottom = '0';
            }
        }
        
        // Initialize bottom nav visibility immediately
        function initBottomNav() {
            try {
                toggleBottomNav();
                // Also check after a short delay to ensure it's visible
                if (window.requestAnimationFrame) {
                    requestAnimationFrame(function() {
                        toggleBottomNav();
                    });
                } else {
                    setTimeout(function() {
                        toggleBottomNav();
                    }, 100);
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–åº•éƒ¨å°èˆªéŒ¯èª¤:', error);
            }
        }
        
        // Initialize immediately if DOM is ready, otherwise wait
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initBottomNav);
        } else {
            initBottomNav();
        }
        if (window.addEventListener) {
            window.addEventListener('resize', toggleBottomNav);
            window.addEventListener('load', function() {
                toggleBottomNav();
            });
        }
        
        // Wrap navigateToSection to update bottom nav
        // Check if navigateToSection exists before wrapping
        if (typeof navigateToSection !== 'undefined') {
            const originalNavigateToSection = navigateToSection;
            navigateToSection = function(section) {
                if (originalNavigateToSection) {
                    originalNavigateToSection(section);
                }
                if (section === null) {
                    updateBottomNav('home');
                } else {
                    updateBottomNav(section);
                }
            };
        }
        
        // Function to open section (used by feature cards)
        function openSection(section) {
            navigateToSection(section);
        }
        
        // Update nav on initial load
        setTimeout(() => {
            if (typeof currentSection !== 'undefined') {
                if (currentSection === null) {
                    updateBottomNav('home');
                } else {
                    updateBottomNav(currentSection);
                }
            } else {
                updateBottomNav('home');
            }
        }, 100);
    </script>
</body>
</html>
