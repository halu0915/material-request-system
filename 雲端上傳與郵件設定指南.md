# 雲端上傳與郵件發送功能設定指南

本系統已內建自動上傳到 Google Drive 和自動發送郵件功能。當建立叫料單時，系統會自動：
1. 生成 Excel 檔案
2. 上傳到 Google Drive（如果已配置）
3. 發送郵件通知（如果已配置）

## 📋 功能說明

### ✅ 已實現的功能

1. **自動上傳到 Google Drive**
   - 建立叫料單時自動上傳 Excel 檔案
   - 檔案會儲存在 Google Drive
   - 自動設定檔案為公開讀取（可選）

2. **自動發送郵件**
   - 建立叫料單時自動發送郵件通知
   - 郵件包含叫料單詳細資訊
   - 附件包含 Excel 檔案

## 🔧 設定步驟

### 步驟 1：設定 Google Drive 上傳功能

#### 1.1 建立 Google Cloud 專案

1. 前往 [Google Cloud Console](https://console.cloud.google.com/)
2. 建立新專案或選擇現有專案
3. 啟用 **Google Drive API**

#### 1.2 建立 OAuth 2.0 憑證

1. 前往「API 和服務」>「憑證」
2. 點擊「建立憑證」>「OAuth 用戶端 ID」
3. 應用程式類型選擇「網頁應用程式」
4. 設定授權重新導向 URI：
   ```
   http://localhost:5000/api/drive/callback  (開發環境)
   https://your-domain.com/api/drive/callback  (生產環境)
   ```
5. 記錄下 **用戶端 ID** 和 **用戶端密鑰**

#### 1.3 取得 Refresh Token

1. 使用以下 URL 取得授權碼（替換 YOUR_CLIENT_ID）：
   ```
   https://accounts.google.com/o/oauth2/v2/auth?client_id=YOUR_CLIENT_ID&redirect_uri=http://localhost:5000/api/drive/callback&response_type=code&scope=https://www.googleapis.com/auth/drive.file&access_type=offline&prompt=consent
   ```

2. 授權後，瀏覽器會重新導向到回調 URL，從 URL 中取得 `code` 參數

3. 使用以下命令取得 Refresh Token（替換 YOUR_CLIENT_ID, YOUR_CLIENT_SECRET, YOUR_CODE）：
   ```bash
   curl -X POST https://oauth2.googleapis.com/token \
     -d "client_id=YOUR_CLIENT_ID" \
     -d "client_secret=YOUR_CLIENT_SECRET" \
     -d "code=YOUR_CODE" \
     -d "grant_type=authorization_code" \
     -d "redirect_uri=http://localhost:5000/api/drive/callback"
   ```

4. 從回應中取得 `refresh_token`

#### 1.4 設定環境變數

在 Render 環境變數或 `.env` 檔案中設定：

```env
GOOGLE_DRIVE_CLIENT_ID=your-google-drive-client-id
GOOGLE_DRIVE_CLIENT_SECRET=your-google-drive-client-secret
GOOGLE_DRIVE_REDIRECT_URI=https://your-domain.com/api/drive/callback
GOOGLE_DRIVE_REFRESH_TOKEN=your-refresh-token
```

### 步驟 2：設定郵件發送功能

#### 2.1 使用 Gmail SMTP（推薦）

1. 登入您的 Gmail 帳號
2. 前往 [Google 帳戶安全性設定](https://myaccount.google.com/security)
3. 啟用「兩步驟驗證」
4. 前往 [應用程式密碼](https://myaccount.google.com/apppasswords)
5. 建立應用程式密碼（選擇「郵件」和「其他」）
6. 記錄下生成的 16 位密碼

#### 2.2 使用其他 SMTP 服務

**Outlook/Hotmail:**
```env
SMTP_HOST=smtp-mail.outlook.com
SMTP_PORT=587
SMTP_USER=your-email@outlook.com
SMTP_PASS=your-password
```

**Yahoo Mail:**
```env
SMTP_HOST=smtp.mail.yahoo.com
SMTP_PORT=587
SMTP_USER=your-email@yahoo.com
SMTP_PASS=your-password
```

**自訂 SMTP 伺服器:**
```env
SMTP_HOST=your-smtp-server.com
SMTP_PORT=587  # 或 465 (SSL)
SMTP_USER=your-email@domain.com
SMTP_PASS=your-password
SMTP_FROM=noreply@your-domain.com
```

#### 2.3 設定環境變數

在 Render 環境變數或 `.env` 檔案中設定：

```env
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password  # Gmail 使用應用程式密碼
SMTP_FROM=noreply@your-domain.com
```

## 📝 Render 環境變數設定

在 Render Dashboard 中設定環境變數：

1. 前往您的服務設定頁面
2. 點擊「Environment」標籤
3. 新增以下環境變數：

### Google Drive 設定
```
GOOGLE_DRIVE_CLIENT_ID=your-client-id
GOOGLE_DRIVE_CLIENT_SECRET=your-client-secret
GOOGLE_DRIVE_REDIRECT_URI=https://your-app.onrender.com/api/drive/callback
GOOGLE_DRIVE_REFRESH_TOKEN=your-refresh-token
```

### 郵件設定
```
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password
SMTP_FROM=noreply@your-domain.com
```

### 公司資訊（可選）
```
COMPANY_NAME=您的公司名稱
COMPANY_TAX_ID=您的統編
```

## 🔍 功能運作方式

### 建立叫料單時的流程

1. **建立叫料單**
   - 用戶填寫叫料單資訊
   - 系統生成叫料單號

2. **生成 Excel**
   - 自動生成格式化的 Excel 檔案
   - 包含公司抬頭、統編、材料明細等

3. **上傳到 Google Drive**（如果已配置）
   - 自動上傳 Excel 檔案到 Google Drive
   - 儲存檔案 URL 到資料庫
   - 如果上傳失敗，不會影響叫料單建立

4. **發送郵件**（如果已配置）
   - 自動發送郵件給建立者
   - 郵件包含叫料單詳細資訊
   - 附件包含 Excel 檔案
   - 如果發送失敗，不會影響叫料單建立

## ⚠️ 注意事項

1. **Google Drive 上傳**
   - 如果未設定環境變數，系統會跳過上傳，但不會報錯
   - 檔案會設定為公開讀取（可選）
   - 建議定期清理舊檔案

2. **郵件發送**
   - 如果未設定環境變數，系統會跳過發送，但不會報錯
   - Gmail 需要使用應用程式密碼，不能使用一般密碼
   - 建議使用專用的發送郵件帳號

3. **錯誤處理**
   - 雲端上傳和郵件發送失敗不會影響叫料單建立
   - 錯誤會記錄在伺服器日誌中
   - 可以透過 Render 日誌查看錯誤訊息

## 🧪 測試功能

### 測試 Google Drive 上傳

1. 建立一個測試叫料單
2. 檢查 Render 日誌，應該看到「上傳雲端成功」或「上傳雲端失敗」訊息
3. 檢查 Google Drive，應該能看到上傳的檔案

### 測試郵件發送

1. 建立一個測試叫料單
2. 檢查 Render 日誌，應該看到「郵件發送成功」或「發送郵件失敗」訊息
3. 檢查收件箱（包括垃圾郵件資料夾）

## 📞 故障排除

### Google Drive 上傳失敗

1. 檢查環境變數是否正確設定
2. 確認 Refresh Token 是否有效
3. 檢查 Google Drive API 是否已啟用
4. 查看 Render 日誌中的錯誤訊息

### 郵件發送失敗

1. 檢查 SMTP 設定是否正確
2. Gmail 使用者確認已使用應用程式密碼
3. 檢查防火牆是否阻擋 SMTP 連線
4. 查看 Render 日誌中的錯誤訊息

## 📚 相關文件

- [Google Drive API 文件](https://developers.google.com/drive/api)
- [Nodemailer 文件](https://nodemailer.com/)
- [Gmail SMTP 設定](https://support.google.com/mail/answer/7126229)

